    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <title>Gantt Chart Sản Xuất</title>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        <style>

            .body {
                box-sizing: border-box;
                font-family: 'Arial', sans-serif;
                margin: 0;
                padding: 0;
                width: fit-content;
            }

           .container-gantt {
              display: flex;
              overflow: auto;
              height: calc(110vh - 210px); /* tuỳ chỉnh theo chiều cao màn hình */
              position: relative;
              scroll-behavior: smooth;
            }


            /* Phần label trái */
            .labels {
                height: fit-content;
              width: 220px;
              position: sticky;
              left: 0;
              z-index: 3;
              background: #f8f9fa;
              border-right: 2px solid #dee2e6;
              display: flex;
              flex-direction: column;
            }
            .label-header {
              padding: 16.5px;
              background: #e9ecef;
              font-weight: bold;
              font-size: 16px;
              text-align: center;
              color: #495057;
              border-bottom: 2px solid #dee2e6;
              position: sticky;
              top: 0;
              z-index: 4;
            }



            .label-body {
              display: flex;
              flex-direction: column;
            }
                        .label-row {
                            height: 200px;
                border-bottom: 1px solid #dee2e6;
                align-items: center;
                justify-content: center;
                font-weight: 500;
                font-size: 18px;
                color: #000000;
                text-align: center;
                line-height: 1.4;
            }

            /* Phần timeline */
            .timeline {
                display: flex;
                height: fit-content;
                flex-direction: column;
                min-width: max-content; /* Ngăn thu nhỏ chiều ngang */
            }


            /* Timeline header */
            .timeline-header {
                display: flex;
                background: #fff;
                position: sticky;
                top: 0;
                z-index: 2;
                border-bottom: 2px solid #dee2e6;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

            .month-section {
                border-left: 1px solid #adb5bd;
            }

            .month-title {
                padding: 10px;
                font-weight: 700;
                background: #e9ecef;
                border-bottom: 1px solid #dee2e6;
                text-align: center;
                font-size: 14px;
                color: #495057;
            }

            .days-container {
                display: flex;
                background: #f8f9fa;
            }

            .day-cell {
                width: 30px;
                height: 35px;
                border-right: 1px solid #dee2e6;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 13px;
                color: #6c757d;
                background: #fff;
                flex-direction: column;
            }

            /* Timeline body */
            .timeline-body {
                position: relative;
                background: repeating-linear-gradient(
                    90deg,
                    transparent 0,
                    transparent 29px,
                    #f8f9fa 30px
                );
            }

            .task-row {
                height: 200px;
                position: relative; /* important for absolute task bars */
                border-bottom: 1px solid #dee2e6;
            }

            .task-bar {
                will-change: transform, left;
                position: absolute;
                height: 160px;
                top: 25px;
                background: linear-gradient(
                    to right,
                    rgba(255, 213, 153, 0.3) 0%,
                    rgba(255, 213, 153, 0.3) 98%,
                    #fff9ed 100%
                );
                border-left: 2px solid #ffab00;
                border-right: 2px solid #ffab00;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                cursor: pointer;
                min-width: 100px;
                box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
                transition: all 0.2s;
                box-sizing: border-box;
            }

            .task-bar:hover {
                transform: translateY(-2px);
                box-shadow: 2px 4px 12px rgba(0,0,0,0.15);
            }

            .task-bar::after {
                content: "";
                position: absolute;
                right: 2px;
                top: -2px;
                bottom: -2px;
                width: 1px;
                background: #ffab00;
                border-radius: 0px 0px 0px 0px;
            }

            .item-code {
                position: absolute;
                top: -20px;
                left: 0;
                background: #d46b08;
                color: white;
                padding: 2px 8px;
                border-radius: 4px 4px 0 0;
                font-size: 12px;
                font-weight: bold;
                z-index: 1;
                box-shadow: 2px -2px 5px rgba(0,0,0,0.1);
            }

            .task-header {
                margin-top: 5px;
                border-bottom: 2px solid #ffd8a8;
            }

            .task-code {
                font-weight: 700;
                font-size: 18px;
                color: #d46b08;
                letter-spacing: 0.5px;
            }

            .task-dates {
                text-align:right;
                margin-right: 5px;
                        }

            .task-date {
                font-size: 13px;
                color: #874d00;
                white-space: nowrap;
            }

            .task-details {
                overflow: hidden;
                display: flex;
                flex-grow: 1;
            }

            .detail-item {
                margin-left: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
                padding: 4px 0;
            }

            .detail-label {
                color: #874d00;
                font-weight: 500;

            }

            .detail-value {
                color: #d46b08;
                font-weight: 600;
                flex-grow: 1;
            }
            .progress-text {
                color: #d46b08;
                font-weight: 600;
                flex-grow: 1;
                font-size: 11px;
            }
            @media (max-width: 768px) {
                

                
                .task-bar {

                    min-width: 80px;
                    padding: 10px;
                }
                
                .task-code {
                    font-size: 16px;
                }
                
                .task-details {
                    display: flex;
                }
            }
            .status{
                text-align: right;
                margin-right: 5px;
            }
            .day-cell.sunday {
                background-color: #ffeaea;
                color: #d32f2f;
                font-weight: bold;
            }

            .day-cell.today {
                background-color: #e3f2fd !important;
                border: 2px solid #2196f3 !important;
                position: relative;
            }

            .today-marker {
                position: absolute;
                bottom: 2px;
                font-size: 9px;
                color: #2196f3;
                font-weight: bold;
                width: 100%;
                text-align: center;
            }
            .detail-pro{
                text-align: right;
                margin-right: 5px;
            }
            .task-bar-tooltip {
                position: absolute;
                z-index: 999;
                background: #fff8dc;
                border: 1px solid #ffcc80;
                padding: 8px 12px;
                border-radius: 6px;
                box-shadow: 2px 2px 10px rgba(0,0,0,0.15);
                font-size: 13px;
                color: #333;
                max-width: auto;
                display: none;
                white-space: normal;
                pointer-events: none;

            }

            .button-taskbar {
                margin-left:10px;
                background: #d46b08;
                color: white;
                border-color: white;
            }
            #updateMenu {
                display: none;
                position: absolute;
                z-index: 9999;
                background: #fff9ed;
                border: 1px solid #ffd8a8;
                box-shadow: 2px 4px 12px rgba(0,0,0,0.1);
                border-radius: 8px;
                padding: 8px 0;
                font-size: 14px;
                min-width: 200px;
                font-family: 'Arial', sans-serif;
                transition: all 0.2s ease;
            }

            #updateMenu ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }

            #updateMenu li {
                padding: 4px 12px;
            }

            #updateMenu .menu-option {
                width: 100%;
                background: transparent;
                border: none;
                text-align: left;
                padding: 10px 12px;
                font-size: 14px;
                color: #874d00;
                font-weight: 500;
                cursor: pointer;        
                transition: background 0.2s;
                border-radius: 4px;
            }

            #updateMenu .menu-option:hover {
                background-color: #fff3cd;
                color: #d46b08;
            }
            .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            }

            .modal-content {

            background: white;
            padding: 20px;
            border-radius: 8px;
            width: auto;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            }

            .close {
              position: absolute;
              top: 10px; right: 15px;
              font-size: 24px;
              cursor: pointer;
            }

            .tab-buttons {
              display: flex;
              margin-bottom: 15px;
              gap: 10px;
            }

            .tab-btn {
              padding: 10px 20px;
              border: none;
              background: #eee;
              cursor: pointer;
              border-radius: 6px;
            }

            .tab-btn.active {
              background: #007BFF;
              color: white;
            }

            .tab-content {
              display: none;
            }

            .tab-content.active {
              display: block;
            }

            .tab-table {
              width: 100%;
              border-collapse: collapse;
            }

            .tab-table th, .tab-table td {
              border: 1px solid #ccc;
              padding: 8px;
              text-align: left;
            }
            /* Modal sản lượng */
    #outputModal.modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
    }

    #outputModal .modal-content {
      background: #fff9ed;
      padding: 20px 30px;
      border-radius: 10px;
      width: 700px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      position: relative;
    }

    #outputModal .modal-content h3 {
      margin-top: 0;
      color: #d46b08;
      font-size: 20px;
      margin-bottom: 10px;
    }

    #outputModal label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
      color: #874d00;
    }

    #outputModal input[type="date"],
    #outputModal input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    #outputModal button {
      margin-top: 15px;
      padding: 10px 16px;
      background: #d46b08;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    #outputModal button:hover {
      background: #a05a06;
    }

    #outputModal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #d46b08;
      cursor: pointer;
    }

    #outputHistory {
      margin-top: 10px;
      padding-left: 20px;
      font-size: 14px;
      color: #333;
      max-height: 150px;
      overflow-y: auto;
    }
     #newTasksModal {
            height: fit-content;
         left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 2000px;
    background-color: #fff9ed;
    border: 1px solid #ffd8a8;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    font-family: 'Arial', sans-serif;
}
    }

    #newTasksModal h3 {
      font-size: 20px;
      color: #d46b08;
      border-bottom: 1px solid #ffd8a8;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    #newTasksModal table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    #newTasksModal th,
    #newTasksModal td {
      border: 1px solid #ccc;
      padding: 10px 12px;
      text-align: left;
    }

    #newTasksModal th {
      background-color: #fff3cd;
      color: #874d00;
      font-weight: 600;
    }

    #newTasksModal tr:nth-child(even) {
      background-color: #fefbe7;
    }

    #newTasksModal .close {
      position: absolute;
      top: 14px;
      right: 20px;
      font-size: 22px;
      cursor: pointer;
      color: #874d00;
      font-weight: bold;
    }

    #newTasksModal .close:hover {
      color: #d32f2f;
    }

    #newTasksModal button {
      padding: 8px 14px;
      background: #d46b08;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 16px;
      transition: background 0.2s;
    }

    #newTasksModal button:hover {
      background: #a35a00;
    }
    .btn {
      font-family: 'Arial', sans-serif;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .btn-eip {
      background-color: #d46b08; /* cam đậm */
      color: white;
      border: 1px solid #d46b08;
    }

    .btn-warning {
      background-color: #d46b08; /* cam đậm */
      color: white;
      border: 1px solid #d46b08;
    }

    .btn-warning:hover {
      background-color: #a35a00; /* cam tối */
      border-color: #a35a00;
    }

    .btn-warning:active {
      background-color: #874d00;
      border-color: #874d00;
    }

    .btn-warning:disabled {
      background-color: #f0d8c0;
      color: #999;
      cursor: not-allowed;
    }
    .task-bar.completed-output {
    background-color: #d3d3d3 !important; /* xám nhạt */
    opacity: 0.85;
    }
  #outputHistory li {
    background-color: #f3f4f6;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 10px;
    margin-bottom: 8px;
    font-size: 14px;
    color: #1f2937;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

#outputHistory li span {
    font-weight: 600;
    color: #111827;
    display: block;
    margin-bottom: 4px;
}

#outputHistory li small {
    font-size: 20px;
    color: #374151;
    padding: 4px 6px;
    border-radius: 4px;
    display: inline-block;
}

#outputHistory .btn-edit,
#outputHistory .btn-delete {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    margin-left: 8px;
    padding: 2px 4px;
    color: #6b7280;
    transition: color 0.2s ease;
}

#outputHistory .btn-edit:hover {
    color: #3b82f6; /* blue-500 */
}

#outputHistory .btn-delete:hover {
    color: #ef4444; /* red-500 */
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  z-index: 9999;
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  width: 80%;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.modal-content h3 {
  margin-top: 0;
}

.modal .close {
  float: right;
  font-size: 20px;
  cursor: pointer;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.report-table th,
.report-table td {
  border: 1px solid #d9b97a;
  padding: 6px 10px;
  text-align: center;
  font-size: 16px;
}

.report-table th {
  background-color: #f0f0f0;
  font-weight: bold;
}
#reportMenu,
#modalSetting {
  position: absolute;
  z-index: 9999;
  background-color: #ffffff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px 0;
  width: 200px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  display: none;
  font-family: 'Segoe UI', sans-serif;
}

#reportMenu button,
#modalSetting button {
  display: block;
  width: 100%;
  padding: 8px 16px;
  background: none;
  border: none;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s ease;
}

#reportMenu button:hover,
#modalSetting button:hover {
  background-color: #f0f0f0;
}

.report-total {
  background-color: #faf99e;
  font-weight: bold;
}
.report-factory-total{
color: red;
background-color: lightskyblue;
}
#modalNewProduct.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-family: 'Arial', sans-serif;
}

#modalNewProduct .modal-content {
  background-color: #fff9ed;
  border: 1px solid #ffd8a8;
  border-radius: 12px;
  padding: 24px 28px;
  width: 850px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  position: relative;
}

#modalNewProduct h3 {
  font-size: 20px;
  color: #d46b08;
  margin-bottom: 16px;
}

#modalNewProduct label {
  display: block;
  margin-top: 12px;
  color: #874d00;
  font-weight: 600;
}

#modalNewProduct input {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  margin-top: 4px;
  box-sizing: border-box;
}

#modalNewProduct .tab-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

#modalNewProduct .tab-btn {
  padding: 8px 16px;
  background-color: #f8f9fa;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  color: #874d00;
  transition: background 0.2s;
}

#modalNewProduct .tab-btn.active {
  background-color: #ffc107;
  color: white;
}

#modalNewProduct .tab-content {
  display: none;
}

#modalNewProduct .tab-content.active {
  display: block;
}

#modalNewProduct table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

#modalNewProduct th, #modalNewProduct td {
  border: 1px solid #e2e2e2;
  padding: 8px 10px;
  text-align: left;
}

#modalNewProduct th {
  background-color: #fff3cd;
  color: #874d00;
}

#modalNewProduct .btn-warning {
  background-color: #d46b08;
  color: white;
  border: none;
  margin-top: 16px;
  padding: 10px 16px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
}

#modalNewProduct .btn-warning:hover {
  background-color: #a35a00;
}

#modalNewProduct .close {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 22px;
  color: #d46b08;
  cursor: pointer;
  font-weight: bold;
}

#splitSizeModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Arial', sans-serif;
}

#splitSizeModal .modal-content {
  background-color: #fff9ed;
  border: 1px solid #ffd8a8;
  border-radius: 12px;
  padding: 24px 28px;
  width: 450px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  position: relative;
}

#splitSizeModal .modal-content h3 {
  font-size: 18px;
  color: #d46b08;
  margin-bottom: 16px;
}

#splitSizeModal input[type="number"] {
  width: 100%;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  box-sizing: border-box;
  margin-top: 4px;
}

#splitSizeModal button {
  padding: 8px 14px;
  background-color: #d46b08;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
}

#splitSizeModal button:hover {
  background-color: #a35a00;
}

#splitSizeModal .button-group {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}
 .btntabsize{

 }
 #outputTotalValue {
  display: inline-block;
  margin: 8px 0;
  padding: 6px 12px;
  background-color: #fff7e6;       /* nền vàng nhạt */
  color: #874d00;                  /* chữ nâu nổi bật */
  font-weight: bold;
  font-size: 18px;
  border: 1px solid #ffd591;       /* viền vàng */
  border-radius: 8px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}


        </style>
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    </head>
            <div class="tools">

              <!-- Thanh công cụ -->
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f5f5f5;">

                <!-- Nhóm nút bên trái -->
                <div>
                  <button id="btnShowNewTasks" class="btn btn-warning">🆕 Mã hàng mới</button>
                  <button id="btnReports" class="btn btn-warning">📊 Báo cáo</button>
                  <button id="btnSetting" class="btn btn-warning">⚙️ Setting</button>

                </div>

                <!-- Nhóm nút bên phải -->
                    <div class="toolbar" style="position: relative;">
                      <input type="text" id="itemSearchInput" placeholder="🔍 Tìm mã hàng (ItemID)" oninput="showItemSuggestions()" style="padding: 6px; margin-right: 10px;">
                      <ul id="itemSuggestions" class="suggestions-list" style="position: absolute; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; width: 300px;"></ul>
                    </div>


                <div>

                  <button class="btn btn-eip" onclick="exportToExcel()">📤 Xuất Excel</button>
                  <input type="file" id="excelImport" accept=".xlsx" style="display: none;" onchange="importFullDataFromExcel()" />
                  <button class="btn btn-eip" onclick="document.getElementById('excelImport').click()">📥 Nhập Excel</button>
                </div>
              </div>

            </div>

  






    <div id="reportMenu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:10px; z-index:999;">
      <h4>📋 Chọn loại báo cáo</h4>
      <button onclick="generateTeamProgressReport('TH1')">✅ TH1 - Theo chuyền</button><br>
      <button onclick="generateTeamProgressReport('TH2')">✅ TH2 - Theo chuyền</button><br>
      <button onclick="exportDailyOutputExcel()">📥 Xuất tiến độ hàng ngày</button>
    </div>

     <!-- Modal Oder -->
    <div id="oderModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close">&times;</span>

        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="productTab">Sản phẩm</button>
          <button class="tab-btn" data-tab="priceTab">Giá sản xuất</button>
          <button class="tab-btn" data-tab="sizeTab">Size</button>
          <button class="tab-btn" data-tab="productivityTab">⏱ Productivity</button>
        </div>

        <div class="tab-content active" id="productTab">
          <table class="tab-table">
            <tr><th>Mã hàng</th><th>Season</th><th>Khách hàng</th><th>PO</th><th>Số lượng</th><th>Ngày Giao Hàng</th></tr>
            <tbody id="productTableBody"></tbody>
          </table>
        </div>

        <div class="tab-content" id="priceTab">
          <table class="tab-table">
            <tr><th>CM</th><th>T</th><th>CMT</th></tr>
            <tbody id="priceTableBody"></tbody>
          </table>
        </div>

        <div class="tab-content" id="sizeTab">
          <table class="tab-table">
            <tr><th>Size</th><th>Số lượng</th></tr>
            <tbody id="sizeTableBody"></tbody>
          </table>
        </div>

                <div class="tab-content" id="productivityTab">
      <table class="tab-table">
        <thead>
          <tr>
            <th>Factory</th>
            <th>Team</th>
            <th>Mã Hàng</th>
            <th>NSBQ(productivity)</th>
            <th>🛠</th>
          </tr>
        </thead>
        <tbody id="productivityTableBody">
          <!-- Dữ liệu sẽ được đổ vào đây -->
        </tbody>
      </table>
    </div>
        </div>
    </div>





    <!-- Modal nhập sản lượng -->
    <div id="outputModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeOutputModal()">&times;</span>
        <h3>📈 Nhập sản lượng hàng ngày</h3>
        <h3 id="outputTeamInfo"></h3>
        <p><strong>Mã hàng:</strong> <span id="outputItemId"></span></p>
        <p><strong>Số lượng kế hoạch:</strong> <span id="outputPlannedQty">0</span></p>
        <label>PO:</label>
        <select id="outputPoSelect"></select>
        <p><strong>Tổng sản lượng:</strong> <span id="outputTotalValue">0</span></p>
        <label>Ngày:</label>
        <input type="date" id="outputDate" />
        <label>Sản lượng:</label>
        <input type="text" id="outputValue" oninput="evaluateExpression(this)" />
        <label>Nhập Hoàn Thành:</label>
        <input type="text" id="outputDone" oninput="evaluateExpression(this)" />
        <label>LK Ủi:</label>
        <input type="text" id="outputIron" oninput="evaluateExpression(this)" />
        <label>LK Kiểm:</label>
        <input type="text" id="outputCheck" oninput="evaluateExpression(this)" />
        <label>Kiểm Đạt:</label>
        <input type="text" id="outputPass" oninput="evaluateExpression(this)" />
        <label>LK Đóng Thùng:</label>
        <input type="text" id="outputBox" oninput="evaluateExpression(this)" />


        <br><br>
        <button onclick="saveOutput()">💾 Lưu</button>
        <hr>
        <h4>Lịch sử sản lượng:</h4>
        <ul id="outputHistory"></ul>


      </div>
    </div>



    </div>
    

    <div id="newTasksModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" id="closeNewTasksModal">&times;</span>
        <h3>Danh sách mã hàng chưa có trong Gantt</h3>
        <button onclick="openNewProductModal()">➕ Nhập mã mới</button>
        <table id="newTasksTable" class="table table-bordered">
          <thead>
            <tr>
              <th>Mã hàng</th>
              <th>Season</th>
              <th>PO</th>
              <th>Số lượng</th>
              <th>Ngày Đồng Bộ NPL</th>
              <th>Ngày Giao Hàng</th>
              <th>Size</th>
              <th>🛠</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <body>

        <!-- Popup menu khi nhấn nút UPDATE -->
        <div id="updateMenu" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 6px; padding: 10px; font-size: 14px;">
        <ul style="list-style: none; padding: 0; margin: 0;">
          <li><button class="menu-option" id="Production">🧾 Product</button></li>
          <li><button class="menu-option" id="Output">📈 Nhập sản lượng</button></li>
          <li><button class="menu-option" id="Split">✂️ Tách mã hàng sản xuất</button></li>
          <li><button class="menu-option" id="Delivery">🚚 Xác nhận giao hàng</button></li>
          <li><button class="menu-option" id="PreStep">🔍 Cộng Đoạn trước SX</button></li>
          <li><button class="menu-option" onclick="handleRemoveFromGantt()">❌ Xoá khỏi Gantt</button></li>
        </ul>
        </div>

        <div class="filter-container">
        <label for="factoryFilter"><strong>Lọc theo Xí Nghiệp:</strong></label>
        <select id="factoryFilter">
        </select>
        </div>
            <div class="container-gantt">
            <!-- Phần label trái (sẽ được tạo động) -->
            <div class="labels">
              <div class="label-header">CHUYỀN/TỔ SẢN XUẤT</div>
              <div class="label-body" id="labelBody"></div>
            </div>


            <!-- Phần timeline -->
            <div class="timeline">
                <div class="timeline-header" id="timelineHeader"></div>
                <div class="timeline-body" id="timelineBody"></div>
            </div>
            </div>
        <div id="customTooltip" class="task-bar-tooltip"></div>
<div id="reportModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <span class="close" onclick="closeReportModal()">&times;</span>
    <h3>📊 Báo cáo tiến độ</h3>
    <div style="margin-bottom:10px;">
  <label for="customerFilterSelect"><strong>🎯 Lọc theo Customer:</strong></label>
  <select id="customerFilterSelect" onchange="generateTeamProgressReport(currentFactoryInReport)">
    <option value="">-- Tất cả --</option>
  </select>
  <button class="btn btn-primary" onclick="exportReportToExcel()">📤 Xuất báo cáo ra Excel</button>
  <button class="btn btn-warning" onclick="checkDeliveryStatus()">🚚 Kiểm tra xuất hàng</button>
</div>
    <div id="reportResult" class="report-result"></div>
    <div style="text-align:right; margin-top:10px;">
  
</div>

  </div>
</div>

<div id="modalNewProduct" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeNewProductModal()">&times;</span>

    <!-- Tab buttons -->
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="productInfoTab" onclick="switchTab('productInfoTab')">📄 Thông tin sản phẩm</button>
      <button class="tab-btn" data-tab="priceInfoTab" onclick="switchTab('priceInfoTab')">💰 Giá</button>
      <button class="tab-btn" data-tab="sizeInfoTab" onclick="switchTab('sizeInfoTab')">📏 Size & SL</button>
    </div>

    <!-- TAB 1: Thông tin sản phẩm -->
    <div class="tab-content active" id="productInfoTab">
      <label>Mã hàng (ItemID):</label>
      <input type="text" id="newItemId" class="input-field" onkeydown="preventSpace(event)" />
      <label>Season/Contract</label>
      <input type="text" id="newSeason" class="input-field" onkeydown="preventSpace(event)" />
      <label>PO:</label>
      <input type="text" id="newPo" class="input-field" onkeydown="preventSpace(event)" />
      <label>Khách hàng (Customer):</label>
      <input type="text" id="newCustomer" class="input-field" onkeydown="preventSpace(event)" />
      <label>Loại sản phẩm (Code):</label>
      <input type="text" id="newCode" class="input-field" onkeydown="preventSpace(event)" />
      <label>Ngày ĐB NPL:</label>
      <input type="date" id="newNplDate" class="input-field" onkeydown="preventSpace(event)" />
      <label>Ngày giao hàng:</label>
      <input type="date" id="newGhDate" class="input-field" onkeydown="preventSpace(event)" />
    </div>

    <!-- TAB 2: Giá -->
   <div class="tab-content" id="priceInfoTab">
  <label>CM (Giá cắt may):</label>
  <input type="number" id="inputCm" class="input-field" onkeydown="preventSpace(event)" step="0.01" placeholder="VD: 0.5" oninput="updateCMT()" />

  <label>T (Giá chỉ):</label>
  <input type="number" id="inputT" class="input-field" onkeydown="preventSpace(event)" step="0.01" placeholder="VD: 0.1" oninput="updateCMT()" />

  <label>CMT (Tổng giá gia công):</label>
  <input type="number" id="inputCmt" class="input-field" onkeydown="preventSpace(event)" readonly />
</div>

    <!-- TAB 3: Size & SL -->
<div class="tab-content" id="sizeInfoTab" >
  <button class="btn btn-warning btn btntabsize" onclick="modalSizeList()">➕ Thêm nhóm size</button>
  <br><br>
  <label>Chọn nhóm size:</label>
  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <input list="sizeGroups" id="sizeGroupInput" class="form-control" style="max-width: 250px;"
           placeholder="Tìm hoặc chọn nhóm size..." onchange="renderSizeTable()" />
    <datalist id="sizeGroups"></datalist>
  </div>
  <table id="newSizeTable" class="table table-bordered">
    <thead>
      <tr><th>Size</th><th>Số lượng</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


    <br />
    <button class="btn btn-warning" onclick="saveNewProduct()">💾 Lưu mã mới</button>
    <button id="btnSaveAdditionalPO" class="btn btn-warning" style="display: none;" onclick="saveAdditionalPo()">💾 UPDATE</button>
    <button onclick="deleteAdditionalPo()" id="btnDeleteAdditionalPO" class="btn btn-warning"  style="display: none;">🗑 DELETE</button>
  </div>
</div>


<!-- Modal tách mã hàng theo size -->
<div id="splitSizeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:#fff; width:400px; margin:100px auto; padding:20px; border-radius:8px; position:relative;">
    <h3 style="margin-top: 0;">✂️ Tách mã hàng theo size</h3>
    <form id="splitSizeForm">
      <div id="splitSizeList" style="margin-bottom:10px; "></div>
      <div style="text-align: right; display: flex;">
        <button type="submit" style="margin-right:10px;">✅ Xác nhận tách</button>
        <button type="button" onclick="closeSplitSizeModal()">❌ Hủy</button>
      </div>
    </form>
  </div>
</div>


    <!-- Menu Setting (kiểu pop-up context menu) -->
<div id="modalSetting" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:10px; z-index:999; box-shadow: 2px 2px 8px rgba(0,0,0,0.2); min-width: 200px;">
  <h4 style="margin-bottom: 8px;">⚙️ Cấu hình</h4>
  <button class="btn btn-light w-full text-left" onclick="openChuyenSetting()">👷 Cấu hình chuyền</button>
  <button class="btn btn-light w-full text-left" onclick="openSizeList()">📏 Danh sách size</button>
  <button class="btn btn-light w-full text-left" onclick="openNgayNghi()">📅 Ngày nghỉ</button>
</div>



<!-- Modal Danh sách size -->
<div id="modalSizeList">
  <div class="modal-content">
    <span class="close" onclick="closeSizeList()">×</span> <!-- Nút đóng -->

    <h3>📏 Danh sách nhóm size</h3>

    <div>
      <label>Tên nhóm size:</label>
      <input type="text" id="groupName" placeholder="VD: S-M-L" />
    </div>
    <div>
      <label>Danh sách size (phân cách bằng dấu phẩy):</label>
      <input type="text" id="groupSizes" placeholder="VD: S,M,L" />
    </div>

    <button class="btn" onclick="addGroupSize()">➕ Thêm nhóm size</button>

    <ul id="groupSizeList" class="list-group"></ul>

    <div style="text-align: right; margin-top: 10px;">
      <button class="btn btn-secondary" onclick="closeSizeList()">Đóng</button>
    </div>
  </div>
</div>


<div id="modalChuyenSetting">
  <div class="modal-content">
    <span class="close" onclick="closeChuyenSetting()">×</span>
    <h3>👷 Cấu hình chuyền</h3>

    <!-- 📦 Danh sách các chuyền -->
    <div id="chuyenSettingsContainer" style="margin-bottom: 30px;"></div>

    <hr/>

    <!-- 🏭 Quản lý nhà máy -->
    <h5>🏭 Quản lý Nhà máy</h5>
    <div style="display:flex; gap:10px; margin-bottom:12px;">
      <input type="text" id="newFactoryName" class="form-control" placeholder="Tên nhà máy mới">
      <button class="btn btn-primary btn-sm" onclick="addFactory()">➕ Thêm nhà máy</button>
    </div>
    <ul id="factoryList" class="list-group"></ul>

    <!-- 👇 Nút đóng -->
    <div style="text-align:right; margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeChuyenSetting()">Đóng</button>
    </div>
  </div>
</div>


<div id="deliveryCheckModal" class="modal" style="display: none;">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <span class="close" onclick="document.getElementById('deliveryCheckModal').style.display='none'">&times;</span>
    <h3>🚚 Báo cáo Kiểm tra Xuất hàng</h3>
    <div id="deliveryCheckResult"></div>
  </div>
</div>

<!-- Modal hiển thị chi tiết mã hàng -->
<div id="itemDetailModal" class="modal" style="display: none;">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <span class="close" onclick="document.getElementById('itemDetailModal').style.display='none'">&times;</span>
    <h3>🔎 Chi tiết mã hàng</h3>
    <div id="itemDetailContent"></div>
  </div>
</div>

<script>

    function calculateTaskPosition(startDateString, endDateString) {
       const parseDate = (str) => {
              if (!str || typeof str !== 'string' || !str.includes('/')) {
                console.warn("❗ parseDate() nhận giá trị không hợp lệ:", str);
                return null;
              }

              const [d, m, y] = str.split('/').map(Number);
              if (isNaN(d) || isNaN(m) || isNaN(y)) {
                console.warn("❗ parseDate() không thể chuyển đổi:", str);
                return null;
              }

              const date = new Date(y, m - 1, d);
              date.setHours(0, 0, 0, 0);
              return date;
       };


        const now = new Date();
        const timelineStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        timelineStart.setHours(0, 0, 0, 0);

        const startDate = parseDate(startDateString);
        const endDate = parseDate(endDateString);
        if (!startDate || !endDate) return null;

        const realStartDate = startDate < timelineStart ? timelineStart : startDate;

        const timelineEnd = new Date(timelineStart);
        timelineEnd.setMonth(timelineEnd.getMonth() + 4);
        timelineEnd.setDate(0);

        const realEndDate = endDate > timelineEnd ? timelineEnd : endDate;

        const startDiff = Math.round((realStartDate - timelineStart) / (1000 * 60 * 60 * 24));
        const duration = Math.round((realEndDate - realStartDate) / (1000 * 60 * 60 * 24)) + 1;

        if (duration <= 0) return null;

        return {
            left: startDiff * 30,
            width: duration * 30
        };
    }
    // ✅ An toàn cho ngày
    function safeDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string' || !dateStr.includes('/')) return '01/01/2099';
        return dateStr;
    }

    // ✅ Chuẩn hóa ngày
    function format(date) {
        if (!(date instanceof Date) || isNaN(date)) return '01/01/2099';
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

</script>

</body>
<script>
                    // ghi chú kết nối bảng  Factorys<=>tasks (Factory && team)
                    // tasks<=>Product (itemId && season )
                    //Product<=>Producttail (itemId && season && po)
                    //
                        const FactoryData = [{Factory: "TH1",
                                        teams: [
                                      

                                        ]
                                      },
                                      {
                                        Factory: "TH2",
                                        teams: [
                                    
                                        ]
                                      }
                                    ];

                        // Dữ liệu mẫu
                        let tasks = [ { Factory: "", itemId: "", season: "" , po: "", status: "", team: "", productivity: ""}];

                        let Product=[ {itemId:"" ,season: "",customer:"" ,code:"" ,po:"",startDate:"",endDate:"" }];
                        // Producttail liên kết vs Product để phân biệt 1 mã hàng cúng itemId vs season nhưng khác Po
                        let Producttail=[{itemId: "",season: "",po: "",quantity:"" ,cm:"",t:"",NplDate: "",GhDate:""}];
                        let size = [{itemId: "",season: "",po: "",sizes: [{ size: "", quantity: "" }]}];
                        let Groupsize = [   ];
                        let tasksWithFullInfo = [];

                        let waitTasks = [{itemId:"",  season:"", po:"", customer:"", code:"", NplDate:"", GhDate:"", Quantity:"", cm:"", t:"", cmt:""}];
                        let waitsize =[{itemId:"", season:"", po:"", groupsize:"1-2-3", quantity:""}];
                        let waitgroupSizes = [{ groupsize:"1-2-3", sizes:[{ size: "S", quantity: 100 },{ size: "M", quantity: 200 },{ size: "L", quantity: 200 }]}];
                        



                          function calculatePro(task) {
                          for (const factory of FactoryData) {
                            const teamData = factory.teams.find(t => t.team === task.team);
                            if (teamData && task.cm > 0) {
                              const baseProductivity = task.productivity || 35; // Nếu có productivity thì dùng, không thì mặc định 35
                              const rawValue = (teamData.sld * baseProductivity) / task.cm;
                              return Math.round(rawValue / 10) * 10; // Làm tròn bội 10
                            }
                          }
                          return 'N/A';
                        }




                         // Hàm tạo labels từ Group
                        function initLabels() {
                        const labelBody = document.getElementById('labelBody');
                        labelBody.innerHTML = ''; // clear cũ nếu có

                        Group.forEach(group => {
                            const labelRow = document.createElement('div');
                            labelRow.className = 'label-row';
                            labelRow.innerHTML = `
                                ${group.team}<br>
                                <span style="font-size:12px;color:#666">Số LĐ: ${group.sld}</span>
                            `;
                            labelBody.appendChild(labelRow);
                        });
                    }


                         // Hàm tạo timeline
                        function initTimeline() {
                        const today = new Date();
                        const header = document.getElementById('timelineHeader');
                        header.innerHTML = '';

                        // Thiết lập ngày bắt đầu của timeline: ngày 1 của tháng trước tháng hiện tại
                            const timelineStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            // Thiết lập ngày kết thúc của timeline: ngày cuối của tháng thứ 3 sau tháng hiện tại
                            const timelineEnd = new Date(today.getFullYear(), today.getMonth() + 4, 0); // Tháng + 3, ngày 0 sẽ ra ngày cuối của tháng trước đó (tức tháng + 2). Để có tháng thứ 3 sau tháng hiện tại, ta cần month + 4, day 0.

                            // Điều chỉnh lại timelineEnd để nó là cuối tháng thứ 3 sau tháng hiện tại
                            // Ví dụ: today là tháng 5. Timeline bắt đầu từ tháng 4, kết thúc tháng 8.
                            // getMonth() + 3 sẽ cho tháng 8. Nếu để ngày 0, nó sẽ là 31/07.
                            // Chúng ta cần ngày cuối của tháng 8, vậy là month + 4, day 0.
                            const actualTimelineEnd = new Date(today.getFullYear(), today.getMonth() + 6, 0);



                            let currentDate = new Date(timelineStart);

                            while (currentDate <= actualTimelineEnd) {
                                const month = currentDate.getMonth() + 1;
                                const year = currentDate.getFullYear();
                                const daysInMonth = new Date(year, month, 0).getDate(); // Số ngày trong tháng hiện tại của vòng lặp

                                const monthDiv = document.createElement('div');
                                monthDiv.className = 'month-section';
                                monthDiv.style.width = `${daysInMonth * 30}px`;

                                // Header tháng
                                const title = document.createElement('div');
                                title.className = 'month-title';
                                title.textContent = `THÁNG ${month}/${year}`;
                                monthDiv.appendChild(title);

                                // Các ngày trong tháng
                                const daysContainer = document.createElement('div');
                                daysContainer.className = 'days-container';

                                for (let day = 1; day <= daysInMonth; day++) {
                                    const dateObj = new Date(year, month - 1, day);
                                    const isSunday = dateObj.getDay() === 0;
                                    const isToday = dateObj.toDateString() === today.toDateString();

                                    const dayCell = document.createElement('div');
                                    dayCell.className = `day-cell${isSunday ? ' sunday' : ''}${isToday ? ' today' : ''}`;
                                    dayCell.innerHTML = `
                                        ${day}
                                        <div>${['CN','T2','T3','T4','T5','T6','T7'][dateObj.getDay()]}</div>
                                        ${isToday ? '<div class="today-marker"></div>' : ''}
                                    `;
                                    daysContainer.appendChild(dayCell);
                                }

                                monthDiv.appendChild(daysContainer);
                                header.appendChild(monthDiv);

                                // Di chuyển đến tháng tiếp theo
                                currentDate.setMonth(currentDate.getMonth() + 1);
                            }
                        }

                         // Hàm tạo các task row
                        const taskListByTeam = {}; // NEW
                        function createTaskRows() {
                        const timelineBody = document.getElementById('timelineBody');
                        timelineBody.innerHTML = '';
                    
                        Group.forEach(group => {
                            const row = document.createElement('div');
                            row.className = 'task-row';
                            row.dataset.team = group.team;
                            timelineBody.appendChild(row);

                            taskListByTeam[group.team] = []; // Init list of tasks for collision detection
                            });
                        }

                        // Tạo task bar
function createTaskBar(task) {
  const pos = calculateTaskPosition(task.startDate, task.endDate);
  if (!pos) return null;

    const tail = Producttail.find(p =>
      p.itemId === task.itemId &&
      p.season === task.season &&
      p.po === task.po
    );



  const taskBar = document.createElement('div');
  taskBar.className = 'task-bar';
  taskBar.style.left = `${pos.left}px`;
  taskBar.style.width = `${pos.width}px`;
  taskBar.setAttribute('data-taskid', `${task.itemId}-${task.po}`);
  taskBar.dataset.itemid = task.itemId;
  taskBar.dataset.season = task.season;
  taskBar.dataset.po = task.po;
  taskBar.dataset.quantity = task.quantity || 0;

  const start = task.startDate.split('/').slice(0, 2).join('/');
  const end = task.endDate.split('/').slice(0, 2).join('/');
if (tail && isLater(task.endDate, tail.GhDate)) {
  taskBar.classList.add('late-task');
}
if (tail && isLater(tail.NplDate, task.startDate)) {
  taskBar.classList.add('npl-late'); // gắn class xanh dương
}

  taskBar.innerHTML = `
    <div class="item-code">MH-${task.itemId}::${task.season}-${task.customer}
      <button class="button-taskbar"
        data-taskid="${task.itemId}-${task.season}-${task.po}"
        data-itemid="${task.itemId}"
        data-season="${task.season}"
        data-po="${task.po}">
        UPDATE
      </button>
    </div>
    <div class="task-header">
      <span class="task-code">${task.code}</span>
      <span class="detail-label">CM(giá):</span>
      <span class="detail-value">${task.cm}USD</span>
      <div class="task-dates">
        <span class="task-date">${start} - ${end}</span>
        <span class="task-date">${pos.width / 30} ngày</span>
      </div>
    </div>
    <div class="task-details">
      <div class="detail-item"><span class="detail-label">PO:</span><span class="detail-value">${task.po}</span></div>
      <div class="detail-item"><span class="detail-label">Số lượng:</span><span class="detail-value">${task.quantity}</span></div>
      <div class="detail-item"><span class="detail-label">ĐB NPL:</span><span class="detail-value">${tail.NplDate}</span></div>
      <div class="detail-item"><span class="detail-label">GH:</span><span class="detail-value">${tail.GhDate}</span></div>
    </div>
    <div class="detail-pro">
      <span class="detail-label">NS:</span>
      <span class="detail-value">${calculatePro(task)}</span>
    </div>
  `;

 if (tail && isLater(task.endDate, tail.GhDate)) {
    const nsRequired = suggestRequiredNS(task, tail.GhDate);
    taskBar.innerHTML += `
      <div class="text-danger" style="padding: 4px 8px; font-size: 13px;color: rgb(135, 77, 0);
    font-weight: bold;">
        ⚠️ NS cần đạt: <strong>${nsRequired}</strong> sp/ngày để kịp GH
      </div>
    `;
  }
  // ✅ Gắn sự kiện và hiển thị
  setupTooltip(taskBar, task);
  setupUpdateMenu(taskBar, task);
  setupMouseDragBehavior(taskBar, task);
  updateProgressText(taskBar, task);
  // ✅ Thêm vào danh sách theo team
  if (task.team) {
    if (!taskListByTeam[task.team]) taskListByTeam[task.team] = [];
    taskListByTeam[task.team].push(taskBar);
  }
 

  return taskBar;
}
function parseDate(str) {
  if (!str) return null;
  const [d, m, y] = str.split('/').map(Number);
  return new Date(y, m - 1, d);
}
function daysBetween(d1, d2) {
  const msPerDay = 1000 * 60 * 60 * 24;
  return Math.ceil((d2 - d1) / msPerDay);
}
function suggestRequiredNS(task, ghDateStr) {
  const quantity = task.quantity || 0;
  const key = `${task.itemId}-${task.season}`;
  const outputList = outputs?.[key]?.[task.po] || [];
  const done = outputList.reduce((sum, o) => sum + o.value, 0);
  const remain = quantity - done;

  const today = new Date();
  const ghDate = parseDate(ghDateStr);
  const totalDays = daysBetween(today, ghDate);
  const sundays = countSundays(today, totalDays);
  const workingDays = totalDays - sundays;

  if (workingDays <= 0) return '∞';

  const rawNS = remain / workingDays;
  return Math.ceil(rawNS / 5) * 5; // 🎯 Làm tròn lên bội số của 5
}


function isLater(d1, d2) {
  const [day1, month1, year1] = d1.split('/').map(Number);
  const [day2, month2, year2] = d2.split('/').map(Number);
  const date1 = new Date(year1, month1 - 1, day1);
  const date2 = new Date(year2, month2 - 1, day2);
  return date1 > date2;
}


function setupTooltip(taskBar, task) {
  taskBar.addEventListener('mouseenter', () => {
    const tooltip = document.getElementById('customTooltip');
    tooltip.style.display = 'block';

    const tail = Producttail.find(p =>
      p.itemId === task.itemId &&
      p.season === task.season &&
      p.po === task.po
    );



    tooltip.innerHTML = `
      <strong>MH:</strong> ${task.itemId}<br/>
      <strong>Sản phẩm:</strong> ${task.code}<br/>
      <strong>CM:</strong> ${task.cm} USD<br/>
      <strong>PO:</strong> ${task.po}<br/>
      <strong>Số lượng:</strong> ${task.quantity}<br/>
      <strong>Ngày ĐB:</strong> ${tail.NplDate}<br/>
      <strong>Giao hàng:</strong> ${tail.GhDate}<br/>
      <strong>Bắt đầu:</strong> ${task.startDate}<br/>
      <strong>Kết thúc:</strong> ${task.endDate}<br/>
      <strong>Năng Suất:</strong> ${calculatePro(task)}<br/>
    `;
  });

  taskBar.addEventListener('mouseleave', () => {
    document.getElementById('customTooltip').style.display = 'none';
  });

  taskBar.addEventListener('mousemove', (e) => {
    const tooltip = document.getElementById('customTooltip');
    tooltip.style.top = `${e.pageY + 15}px`;
    tooltip.style.left = `${e.pageX + 15}px`;
  });
}


// ✅ Menu cập nhật task
function setupUpdateMenu(taskBar, task) {
  const updateBtn = taskBar.querySelector('.button-taskbar');
  const menu = document.getElementById('updateMenu');
  if (!updateBtn || !menu) return;

  updateBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    menu.style.display = 'block';
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
    menu.dataset.itemId = task.itemId;
    menu.dataset.season = task.season;
    menu.dataset.po = task.po;
  });

  document.addEventListener('click', (e) => {
    if (!menu.contains(e.target)) {
      menu.style.display = 'none';
    }
  });
}

// ✅ Cập nhật % hoàn thành
function updateProgressText(taskBar, task) {
  const product = Producttail.find(p => p.itemId === task.itemId && p.po === task.po);
  const plan = product?.quantity || 0;
  const outputList = outputs[`${task.itemId}-${task.season}`]?.[task.po];
  const done = outputList ? outputList.reduce((s, e) => s + e.value, 0) : 0;
  const percent = plan > 0 ? ((done / plan) * 100).toFixed(1) : 0;

  const el = document.createElement('div');
  el.className = 'task-progress';
  el.style.cssText = 'text-align:center; font-size:13px; font-weight:bold; color:#874d00; margin-top:4px;';
  el.textContent = `Tiến độ: ${percent}%`;
  taskBar.appendChild(el);
}

// ✅ Xử lý kéo – thả, tránh chồng task
function setupMouseDragBehavior(taskBar, task) {
  let isDragging = false;
  let startX = 0, startY = 0, initialLeft = 0;
  let originalTeam = '';

  taskBar.addEventListener('mousedown', (e) => {
    e.preventDefault();
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    initialLeft = parseInt(taskBar.style.left, 10);
    originalTeam = taskBar.parentElement?.dataset?.team || '';
    taskBar.style.transition = 'none';
    document.body.style.userSelect = 'none';
  });

  window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const deltaX = e.clientX - startX;
    let newLeft = Math.round((initialLeft + deltaX) / 30) * 30;
    const maxLeft = document.getElementById('timelineHeader').offsetWidth - taskBar.offsetWidth;
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    taskBar.style.left = `${newLeft}px`;

    // chuyển dòng nếu kéo dọc
    const rows = Array.from(document.querySelectorAll('#timelineBody .task-row'));
    const newRow = rows.find(row => {
      const rect = row.getBoundingClientRect();
      return e.clientY >= rect.top && e.clientY <= rect.bottom;
    });

    if (newRow && newRow !== taskBar.parentElement) {
      const newTeam = newRow.dataset.team;
      const oldList = taskListByTeam[originalTeam] || [];
      taskListByTeam[originalTeam] = oldList.filter(t => t !== taskBar);
      taskListByTeam[newTeam] = taskListByTeam[newTeam] || [];
      taskListByTeam[newTeam].push(taskBar);

      taskBar.parentElement?.removeChild(taskBar);
      newRow.appendChild(taskBar);
      task.team = newTeam;
      originalTeam = newTeam;
    }
  });

  window.addEventListener('mouseup', () => {
    if (!isDragging) return;
    isDragging = false;

    taskBar.style.transition = '';
    document.body.style.userSelect = '';

    // 📦 Auto tránh chồng
    const team = task.team;
    const others = taskListByTeam[team]?.filter(t => t !== taskBar) || [];
    let left = parseInt(taskBar.style.left, 10);
    const width = parseInt(taskBar.style.width, 10);
    const maxLeft = document.getElementById('timelineHeader').offsetWidth - width;

    while (true) {
      const overlap = others.find(t => {
        const l = parseInt(t.style.left, 10);
        const r = l + parseInt(t.style.width, 10);
        return !(left + width <= l || left >= r);
      });
      if (!overlap) break;
      left = Math.min(maxLeft, parseInt(overlap.style.left, 10) + parseInt(overlap.style.width, 10));
    }

    taskBar.style.left = `${left}px`;

    const timelineStart = new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1);
    const startOffset = Math.round(left / 30);
    const newStartDate = new Date(timelineStart);
    newStartDate.setDate(newStartDate.getDate() + startOffset);
    const newEndDate = new Date(newStartDate);
    newEndDate.setDate(newEndDate.getDate() + Math.round(width / 30) - 1);

    task.startDate = formatDate(newStartDate);
    task.endDate = formatDate(newEndDate);

    const poList = Array.isArray(task.po) ? task.po : [task.po];
    poList.forEach(po => {
      const p = Product.find(pr => pr.itemId === task.itemId && pr.season === task.season && pr.po === po);
      if (p) {
        p.startDate = task.startDate;
        p.endDate = task.endDate;
      }

      const t = tasks.find(tk => tk.itemId === task.itemId && tk.season === task.season && tk.po === po);
      if (t) {
        t.team = task.team;
        recalculateEndDate(task.itemId, task.season, po);
      }

      refreshTaskBarText(task.itemId, task.season, po);
    });

    const start = task.startDate.split('/').slice(0, 2).join('/');
    const end = task.endDate.split('/').slice(0, 2).join('/');
    const taskDates = taskBar.querySelectorAll('.task-date');
    if (taskDates[0]) taskDates[0].textContent = `${start} - ${end}`;
    if (taskDates[1]) taskDates[1].textContent = `${Math.round(width / 30)} ngày`;

    taskBar.style.boxShadow = '0 0 5px 2px #ffab00';
    setTimeout(() => taskBar.style.boxShadow = '', 1000);
  });
} 



                        // Hàm định dạng ngày dd/mm/yyyy
                        function formatDate(date) {
                          const d = date.getDate().toString().padStart(2, '0');
                          const m = (date.getMonth() + 1).toString().padStart(2, '0');
                          const y = date.getFullYear();
                          return `${d}/${m}/${y}`;
                        }


                        //conect data = itemid,season, po
               function mergeTaskWithProductAndTail(taskList, productList, producttailList, sizeList = []) {
                return taskList.map(task => {
                    const product = productList.find(p =>
                        p.itemId === task.itemId &&
                        p.season === task.season &&
                        (Array.isArray(task.po) ? task.po.includes(p.po) : p.po === task.po)
                    );

                    const tail = producttailList.find(pt =>
                        pt.itemId === task.itemId &&
                        pt.season === task.season &&
                        (Array.isArray(task.po) ? task.po.includes(pt.po) : pt.po === task.po)
                    );

                    const sizeEntry = sizeList?.find(s =>
                        s.itemId === task.itemId &&
                        s.season === task.season &&
                        (!s.po ||
                         (Array.isArray(task.po) ? task.po.includes(s.po) : s.po === task.po))
                    );

                    return {
                        ...task,
                        code: product?.code,
                        customer: product?.customer,
                        startDate: product?.startDate,
                        cm: tail?.cm,
                        t: tail?.t,
                        NplDate: tail?.NplDate,
                        GhDate: tail?.GhDate,
                        endDate: product?.endDate,
                        quantity: tail?.quantity,
                        sizes: sizeEntry ? sizeEntry.sizes : []
                    };
                });
            }



                function normalizeTasks(tasks) {
                    const result = [];
                    tasks.forEach(task => {
                        if (Array.isArray(task.po)) {
                            task.po.forEach(poItem => {
                                result.push({ ...task, po: poItem });
                            });
                        } else {
                            result.push(task);
                        }
                    });
                    return result;
                }

        function renderTasksByFactory(factory) {
              // 🔄 Xóa cũ
              document.querySelector('.labels').innerHTML = `
                <div class="label-header">CHUYỀN/TỔ SẢN XUẤT</div>
                <div class="label-body" id="labelBody"></div>
              `;
              document.getElementById('timelineBody').innerHTML = '';

              const currentFactory = FactoryData.find(f => f.Factory === factory);
              if (!currentFactory) return;

              // ✅ Gán nhóm chuyền cho biến toàn cục Group (nếu bạn đang dùng)
              Group = currentFactory.teams;

              // ✅ Tạo label cho từng team (chuyền)
              const labelBody = document.getElementById('labelBody');
              currentFactory.teams.forEach(teamObj => {
                const labelRow = document.createElement('div');
                labelRow.className = 'label-row';
                labelRow.innerHTML = `
                  ${teamObj.team}<br>
                  <span style="font-size:12px;color:#666">Số LĐ: ${teamObj.sld}</span>
                `;
                labelBody.appendChild(labelRow);
              });

              // ✅ Tạo dòng hiển thị task-bar cho từng chuyền

              currentFactory.teams.forEach(teamObj => {
                const row = document.createElement('div');
                row.className = 'task-row';
                row.dataset.team = teamObj.team;
                document.getElementById('timelineBody').appendChild(row);

                taskListByTeam[teamObj.team] = [];
              });

              // ✅ Chuẩn hóa và lọc task theo factory
              const normalizedTasks = normalizeTasks(tasks);
              const filteredTasks = normalizedTasks.filter(t => t.Factory === factory);

              // ✅ Ghép thêm thông tin chi tiết
              const enriched = mergeTaskWithProductAndTail(filteredTasks, Product, Producttail);

              // ✅ Vẽ từng task-bar
              enriched.forEach(task => {
                const taskRow = document.querySelector(`.task-row[data-team="${task.team}"]`);
                if (taskRow) {
                  const taskBar = createTaskBar(task);
                  if (taskBar) {
                    taskRow.appendChild(taskBar);
                    taskListByTeam[task.team].push(taskBar);
                    refreshTaskBarText(task.itemId, task.season, task.po);
                  }
                }
              });
            }



           window.onload = () => {
            const datalist = document.getElementById('sizeGroups');
          datalist.innerHTML = ''; // Clear cũ nếu có

          Groupsize.forEach(group => {
            const option = document.createElement('option');
            option.value = group.groupsize; // ✅ đúng tên trường
            datalist.appendChild(option);
          });

          // Các thao tác khởi tạo khác:
          initTimeline();
          renderTasksByFactory('TH1');

          const factorySelect = document.getElementById('factoryFilter');
          FactoryData.forEach(factory => {
            const option = document.createElement('option');
            option.value = factory.Factory;
            option.textContent = `XN ${factory.Factory}`;
            factorySelect.appendChild(option);
          });

          factorySelect.value = 'TH1';
        };


            document.getElementById('factoryFilter').addEventListener('change', function () {
                const selected = this.value;
                renderTasksByFactory(selected);
            });


            //hàm click button update
            document.addEventListener('click', (e) => {
            const menu = document.getElementById('updateMenu');
            if (!menu.contains(e.target)) {
            menu.style.display = 'none';
            }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                document.getElementById('updateMenu').style.display = 'none';
                }
            });


             // Scroll đến ngày hôm nay
            setTimeout(() => {
                const todayCell = document.querySelector('.day-cell.today');
                if (todayCell) {
                todayCell.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            }, 300);

function openOderModal(itemId, season, po, team = null) {
  // === 1. Lọc dữ liệu liên quan ===
  const productList = Product.filter(p =>
    p.itemId === itemId && p.season === season && p.po === po
  );
  const producttailList = Producttail.filter(p =>
    p.itemId === itemId && p.season === season && p.po === po
  );
  const sizeDataList = size.filter(s =>
    s.itemId === itemId && s.season === season && s.po === po
  );

  const relatedTasks = tasks.filter(t =>
    t.itemId === itemId &&
    t.season === season &&
    ((Array.isArray(t.po) && t.po.includes(po)) || t.po === po) &&
    (!team || t.team === team)
  );

  if (!productList.length || !producttailList.length) {
    alert('⚠️ Không tìm thấy thông tin mã hàng hợp lệ!');
    return;
  }

  // === 2. Mở modal ===
  const modal = document.getElementById('oderModal');
  modal.style.display = 'flex';

  // Reset active tab
  document.querySelectorAll('#oderModal .tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('#oderModal .tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelector('.tab-btn[data-tab="productTab"]').classList.add('active');
  document.getElementById('productTab').classList.add('active');

  // === 3. TAB: Sản phẩm ===
  const prodBody = document.getElementById('productTableBody');
prodBody.innerHTML = '';

producttailList.forEach(pt => {
  const product = productList.find(p => p.po === pt.po);
  const tailIndex = Producttail.indexOf(pt); // để cập nhật lại dữ liệu

  if (product) {
    prodBody.innerHTML += `
      <tr>
        <td>${pt.itemId}</td>
        <td>${pt.season}</td>
        <td>${product.customer || ''}</td>
        <td>${pt.po}</td>
        <td>${pt.quantity}</td>
        <td>
          <input type="date" value="${formatDateInput(pt.GhDate)}" 
            onchange="updateGhDate(${tailIndex}, this)" />
          <button onclick="saveGhDate(${tailIndex}, this)">✔️</button>
        </td>
      </tr>`;
  }
});


  // === 4. TAB: Giá sản xuất ===
 const priceBody = document.getElementById('priceTableBody');
priceBody.innerHTML = '';

producttailList.forEach((pt, index) => {
  const cmt = (pt.cm || 0) + (pt.t || 0);
  const ptIndex = Producttail.indexOf(pt); // dùng để cập nhật đúng dòng

  priceBody.innerHTML += `
    <tr>
      <td>
        <input type="number" step="0.01" min="0" value="${pt.cm || 0}"
          onchange="updateCm(${ptIndex}, this)" style="width: 80px;" />
      </td>
      <td>
        <input type="number" step="0.01" min="0" value="${pt.t || 0}"
          onchange="updateT(${ptIndex}, this)" style="width: 80px;" />
      </td>
      <td id="cmt-${ptIndex}">${cmt.toFixed(2)} $</td>
      <td>
        <button onclick="savePrice(${ptIndex})">✔️</button>
      </td>
    </tr>`;
});

  // === 5. TAB: Size ===
const sizeBody = document.getElementById('sizeTableBody');
sizeBody.innerHTML = '';

// Tạo set để lưu unique theo "size + quantity"
const seen = new Set();

sizeDataList.forEach(s => {
  s.sizes.forEach(sz => {
    const key = `${sz.size}|${sz.quantity}`;
    if (!seen.has(key)) {
      seen.add(key);
      sizeBody.innerHTML += `<tr><td>${sz.size}</td><td>${sz.quantity}</td></tr>`;
    }
  });
});



  // === 6. TAB: Productivity (có thể chỉnh sửa) ===
  const tbody = document.getElementById('productivityTableBody');
  tbody.innerHTML = '';

  relatedTasks.forEach(task => {
    const ns = task.productivity || calculatePro(task) || '';
    const taskIndex = tasks.indexOf(task);

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${task.Factory}</td>
      <td>${task.team}</td>
      <td>${task.itemId} (${task.po})</td>
      <td>
        <input type="number" min="1" value="${ns}" 
          onchange="tasks[${taskIndex}].productivity = parseInt(this.value) || 0;
                    recalculateEndDate(tasks[${taskIndex}]);
                    refreshTaskBarText('${task.itemId}', '${task.season}', '${task.po}');" 
          style="width: 80px;" />
      </td>
      <td>
        <button onclick="saveProductivity(${taskIndex}, this)">✔️</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}



function formatDateInput(dateStr) {
  if (!dateStr) return '';
  const [d, m, y] = dateStr.split('/');
  return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
}

function updateGhDate(index, input) {
  const newDate = input.value;
  if (!newDate) return;

  // Chuyển yyyy-mm-dd => dd/mm/yyyy
  const [y, m, d] = newDate.split('-');
  Producttail[index].GhDate = `${d}/${m}/${y}`;
}
function saveGhDate(index, btn) {
  alert('✅ Đã cập nhật ngày giao hàng: ' + Producttail[index].GhDate);
  saveDataToLocalStorage(); // nếu có lưu localStorage
}

function updateCm(index, input) {
  Producttail[index].cm = parseFloat(input.value) || 0;
  updateCMT(index);
}
function updateT(index, input) {
  Producttail[index].t = parseFloat(input.value) || 0;
  updateCMT(index);
}
function updateCMT(index) {
  const pt = Producttail[index];
  const cmt = (pt.cm || 0) + (pt.t || 0);
  const cmtCell = document.getElementById(`cmt-${index}`);
  if (cmtCell) cmtCell.textContent = `${cmt.toFixed(2)} $`;
}
function savePrice(index) {
  alert(`✅ Đã cập nhật giá cho PO: ${Producttail[index].po}\nCM: ${Producttail[index].cm} | T: ${Producttail[index].t}`);
  saveDataToLocalStorage(); // Nếu bạn muốn lưu lại
}

        function saveProductivity(taskIndex, buttonEl) {
          const input = buttonEl.closest('tr').querySelector('input[type="number"]');
          const value = parseInt(input.value) || 0;

          if (value <= 0) {
            alert('⚠️ NSBQ không hợp lệ.');
            return;
          }

          const task = tasks[taskIndex];
          task.productivity = value;

          // Tính lại NSBQ
          const newNS = calculatePro(task);

          // ✅ Cập nhật ngày kết thúc
          recalculateEndDate(task.itemId, task.season, task.po);

          // ✅ Cập nhật lại thanh tiến độ
          refreshTaskBarText(task.itemId, task.season, task.po);

          // ✅sizeSheet Vẽ lại Gantt cho nhà máy hiện tại
          const currentFactory = document.getElementById('factoryFilter')?.value || 'TH1';
          renderTasksByFactory(currentFactory);

          alert(`✅ Đã cập nhật NSBQ mới: ${newNS}`);
        }




            // Đóng modal
            document.querySelector('#oderModal .close').addEventListener('click', () => {
                document.getElementById('oderModal').style.display = 'none';
            });

            // Xử lý chuyển tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });


    function openSizeModal(itemId, season, po) {
    const modal = document.getElementById('sizeModal');
    const tbody = document.getElementById('sizeTable').querySelector('tbody');
    tbody.innerHTML = '';

    // Tìm entry size theo itemId + season + po
    const existing = size.find(s => s.itemId === itemId && s.season === season && s.po === po);
    const sizes = existing ? existing.sizes : [
        { size: 'S', quantity: 0 },
        { size: 'M', quantity: 0 },
        { size: 'L', quantity: 0 },
        { size: 'XL', quantity: 0 },
        { size: 'XXL', quantity: 0 }
    ];

    sizes.forEach(sz => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${sz.size}</td>
            <td><input type="number" min="0" value="${sz.quantity}" data-size="${sz.size}"></td>
        `;
        tbody.appendChild(row);
    });

    const sizeItemIdEl = document.getElementById('sizeItemId');
    sizeItemIdEl.textContent = itemId;
    sizeItemIdEl.dataset.season = season;
    sizeItemIdEl.dataset.po = po;

    modal.style.display = 'flex';
            }



            function closeSizeModal() {
                document.getElementById('sizeModal').style.display = 'none';
            }

            function saveSizeData() {
                const itemId = document.getElementById('sizeItemId').textContent;
                const inputs = document.querySelectorAll('#sizeTable input');

                const updatedSizes = Array.from(inputs).map(input => ({
                    size: input.dataset.size,
                    quantity: parseInt(input.value, 10) || 0
                }));

                const index = size.findIndex(s => s.itemId === itemId);
                if (index >= 0) {
                    size[index].sizes = updatedSizes;
                } else {
                    size.push({ itemId, season, sizes: updatedSizes });
                }

                console.log(`✅ Đã lưu size cho ${itemId}:`, updatedSizes);
                closeSizeModal();
            }

 
    const outputs = { "AZ123-2025": [ { date: '2025-06-01', value: 200 } ] };

function openOutputModal(taskId) {
  const menu = document.getElementById('updateMenu');
  const itemId = menu.dataset.itemId;
  const season = menu.dataset.season;
  const po = menu.dataset.po;

  const matchedPOs = Producttail.filter(p =>
    p.itemId === itemId && p.season === season
  );

  if (matchedPOs.length === 0) {
    alert(`❗Không tìm thấy PO phù hợp với Mã hàng: ${itemId}, Season: ${season}`);
    return;
  }

  const matchedTask = tasks.find(t =>
    t.itemId === itemId &&
    t.season === season &&
    (Array.isArray(t.po) ? t.po.includes(po) : t.po === po)
  );

  // ✅ Gán thông tin chuyền + xưởng nếu có
  document.getElementById('outputTeamInfo').textContent =
    matchedTask ? `Chuyền: ${matchedTask.team} - Xưởng: ${matchedTask.Factory}` : '';

  const poSelect = document.getElementById('outputPoSelect');
  poSelect.innerHTML = '';
  matchedPOs.forEach(p => {
    const option = document.createElement('option');
    option.value = p.po;
    option.textContent = p.po;
    poSelect.appendChild(option);
  });

  // ✅ Gán ngày hiện tại
  document.getElementById('outputDate').value = new Date().toISOString().split('T')[0];

  // ✅ Reset các input
  document.getElementById('outputValue').value = '';
  document.getElementById('outputDone').value = '';
  document.getElementById('outputIron').value = '';
  document.getElementById('outputCheck').value = '';
  document.getElementById('outputPass').value = '';
  document.getElementById('outputBox').value = '';
  document.getElementById('outputTotalValue').textContent = '0';

  // ✅ Gán dataset + text cho mã hàng
  const outputIdEl = document.getElementById('outputItemId');
  outputIdEl.textContent = `${itemId}-${season}`;
  outputIdEl.dataset.itemId = itemId;
  outputIdEl.dataset.season = season;

  const newPoSelect = poSelect.cloneNode(true);
  poSelect.parentNode.replaceChild(newPoSelect, poSelect);

  const firstPO = matchedPOs.find(p => p.po === po) ? po : matchedPOs[0].po;
  newPoSelect.value = firstPO;
  newPoSelect.dataset.po = firstPO;

  // ✅ Gán số lượng kế hoạch ban đầu
  const selectedPO = matchedPOs.find(p => p.po === firstPO);
  document.getElementById('outputPlannedQty').textContent = selectedPO?.quantity || 0;

  // ✅ Load lịch sử output ban đầu
  loadOutputHistory(itemId, season, firstPO);

  // ✅ Khi người dùng đổi PO
  newPoSelect.addEventListener('change', () => {
    const selectedPo = newPoSelect.value;
    newPoSelect.dataset.po = selectedPo;
    loadOutputHistory(itemId, season, selectedPo);

    const selected = matchedPOs.find(p => p.po === selectedPo);
    document.getElementById('outputPlannedQty').textContent = selected?.quantity || 0;
  });

  // ✅ Hiện modal
  document.getElementById('outputModal').style.display = 'flex';
}





function resetOutputModal() {
  const ids = ['outputValue', 'outputDone', 'outputIron', 'outputCheck', 'outputPass', 'outputBox'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  const dateInput = document.getElementById('outputDate');
  if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
}

            function closeOutputModal() {
                document.getElementById('outputModal').style.display = 'none';
            }
let ProductComplete = [];
function getOutputValue(id) {
  const el = document.getElementById(id);
  if (!el) return 0;
  const val = el.dataset.result || el.value || '0';
  return parseInt(val);
}

function saveOutput() {
  const outputEl = document.getElementById('outputItemId');
  const poEl = document.getElementById('outputPoSelect');

  const itemId = outputEl?.dataset?.itemId;
  const season = outputEl?.dataset?.season;
  const po = poEl?.dataset?.po;

  const date = document.getElementById('outputDate').value;
 const value = parseInt(document.getElementById('outputValue').dataset.value || 0);
const done = parseInt(document.getElementById('outputDone').dataset.value || 0);
const iron = parseInt(document.getElementById('outputIron').dataset.value || 0);
const check = parseInt(document.getElementById('outputCheck').dataset.value || 0);
const pass = parseInt(document.getElementById('outputPass').dataset.value || 0);
const box = parseInt(document.getElementById('outputBox').dataset.value || 0);


  // ❌ Kiểm tra dữ liệu thiếu
  if (!itemId || !season || !po || !date || isNaN(value)) {
    alert("❗ Vui lòng nhập đầy đủ thông tin hợp lệ!");
    return;
  }

  const taskKey = `${itemId}-${season}`;
  if (!outputs[taskKey]) outputs[taskKey] = {};
  if (!outputs[taskKey][po]) outputs[taskKey][po] = [];

  const history = outputs[taskKey][po];
  const existingIndex = history.findIndex(e => e.date === date);

  // 🧮 Tổng hiện tại (loại trừ ngày đang sửa)
  const sum = { value: 0, done: 0, iron: 0, check: 0, pass: 0, box: 0 };
  history.forEach((e, i) => {
    if (i !== existingIndex) {
      sum.value += e.value || 0;
      sum.done += e.done || 0;
      sum.iron += e.iron || 0;
      sum.check += e.check || 0;
      sum.pass += e.pass || 0;
      sum.box += e.box || 0;
    }
  });

  const newEntry = { date, value, done, iron, check, pass, box };
  const totalValue = sum.value + value;
  const totalDone = sum.done + done;
  const totalIron = sum.iron + iron;
  const totalCheck = sum.check + check;
  const totalPass = sum.pass + pass;
  const totalBox = sum.box + box;

  // ❌ Kiểm tra tiến độ sai thứ tự
 const errors = [];
if (totalValue < totalDone) errors.push(`Tổng (${totalValue}) < HT (${totalDone})`);
if (totalDone < totalIron) errors.push(`HT (${totalDone}) < Ủi (${totalIron})`);
if (totalIron < totalCheck) errors.push(`Ủi (${totalIron}) < Kiểm (${totalCheck})`);
if (totalCheck < totalPass) errors.push(`Kiểm (${totalCheck}) < Đạt (${totalPass})`);
if (totalPass < totalBox) errors.push(`Đạt (${totalPass}) < Đóng thùng (${totalBox})`);

if (errors.length > 0) {
 let errorMsg = "❗ Dữ liệu không hợp lệ!\nChi tiết lỗi:\n- " + errors.join("\n- ");
  alert(errorMsg);
  return;
}

  // ✅ Cập nhật hoặc thêm mới dòng dữ liệu
  if (existingIndex >= 0) {
    history[existingIndex] = newEntry;
  } else {
    history.push(newEntry);
  }

  // ✅ Cập nhật tiến độ và ngày kết thúc
  loadOutputHistory(itemId, season, po);
  updateTaskProgress(itemId, season, po);
  recalculateEndDate(itemId, season, po);

  // ✅ Nếu chưa có ngày bắt đầu thì gán
  const currentTask = tasks.find(t =>
    t.itemId === itemId &&
    t.season === season &&
    (Array.isArray(t.po) ? t.po.includes(po) : t.po === po)
  );

  if (currentTask && (!currentTask.startDate || currentTask.startDate.trim() === "")) {
    const today = formatDate(new Date());
    currentTask.startDate = today;

    const productIdx = Product.findIndex(p =>
      p.itemId === itemId && p.season === season && p.po === po
    );
    if (productIdx >= 0) {
      Product[productIdx].startDate = today;
      recalculateEndDate(itemId, season, po);
      const product = Product.find(p => p.itemId === itemId && p.season === season && p.po === po);
      if (product) currentTask.endDate = product.endDate;
    }
  }

  // ✅ Vẽ lại Gantt nếu cần
  if (currentTask) {
    const factory = currentTask.Factory;
    adjustStartDatesByTeam(factory);
    tasksWithFullInfo = mergeTaskWithProductAndTail(tasks, Product, Producttail, size);
    checkOverlappingTasks(factory);
    renderTasksByFactory(factory);
    updatedEndDates.length = 0;
  }

  refreshTaskBarText(itemId, season, po);

  // ✅ Kiểm tra đã hoàn thành toàn bộ (Box >= Quantity)
  const detail = Producttail.find(p =>
    p.itemId === itemId && p.season === season && p.po === po
  );
  const plannedQty = parseInt(detail?.quantity || 0);

  if (plannedQty > 0 && totalBox >= plannedQty) {
    if (!window.ProductComplete) window.ProductComplete = [];

    // ✅ Lưu vào danh sách hoàn thành
    ProductComplete.push({
      itemId,
      season,
      po,
      customer: detail?.customer || '',
      code: detail?.code || '',
      quantity: plannedQty,
      cm: detail?.cm || 0,
      t: detail?.t || 0,
      NplDate: detail?.NplDate || '',
      GhDate: detail?.GhDate || '',
      completeDate: date
    });

    // ✅ Xoá khỏi Gantt mà không mở modal
removeTaskFromGantt(itemId, season, po, 'auto');


    // ✅ Xoá khỏi danh sách chờ
    waitTasks = waitTasks.filter(t => !(t.itemId === itemId && t.season === season && t.po === po));
    waitsize = waitsize.filter(s => !(s.itemId === itemId && s.season === season && s.po === po));

    alert(`🎉 Mã hàng ${itemId} - ${po} đã hoàn thành và được chuyển khỏi Gantt!`);
    return;
  }

  alert('✅ Đã lưu sản lượng và cập nhật tiến độ!');
}







        function checkOverlappingTasks(factory) {
            const enriched = mergeTaskWithProductAndTail(tasks, Product, Producttail);
            const groupedByTeam = {};
            let hasOverlap = false;

            enriched.forEach(task => {
                if (task.Factory !== factory) return;
                if (!groupedByTeam[task.team]) groupedByTeam[task.team] = [];
                groupedByTeam[task.team].push(task);
            });

            Object.keys(groupedByTeam).forEach(team => {
                const sorted = groupedByTeam[team].sort((a, b) => {
                    const d1 = new Date(a.startDate.split('/').reverse().join('/'));
                    const d2 = new Date(b.startDate.split('/').reverse().join('/'));
                    return d1 - d2;
                });

                for (let i = 1; i < sorted.length; i++) {
                    const prevEnd = new Date(sorted[i - 1].endDate.split('/').reverse().join('/'));
                    const currStart = new Date(sorted[i].startDate.split('/').reverse().join('/'));

                    if (currStart <= prevEnd) {
                        console.warn(`❌ Task bị chồng: ${sorted[i].itemId} - ${sorted[i].po}`);
                        hasOverlap = true;
                    }
                }
            });

            if (hasOverlap) {
                alert('⚠️ Có task bị chồng lịch trong cùng chuyền!');
            }
        }


        function countSundays(startDate, numWorkingDays) {
          let sundays = 0;
          let counted = 0;
          const date = new Date(startDate);

          while (counted < numWorkingDays) {
            date.setDate(date.getDate() + 1);
            const day = date.getDay();

            if (day === 0) {
              sundays++;
            } else {
              counted++;
            }
          }

          return sundays;
        }


function countSundaysBetween(startDate, endDate) {
  let count = 0;
  // Tạo một bản sao để không làm thay đổi ngày gốc
  let current = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());

  while (current <= endDate) {
    if (current.getDay() === 0) { // 0 là ngày Chủ nhật
      count++;
    }
    current.setDate(current.getDate() + 1);
  }
  return count;
}


        function formatDate(input) {
            const d = new Date(input);
            if (isNaN(d)) return input; // Trường hợp date không hợp lệ
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

    function loadOutputHistory(itemId, season, po) {
    const taskKey = `${itemId}-${season}`;
    const history = (outputs[taskKey] && outputs[taskKey][po]) || [];

    const list = document.getElementById('outputHistory');
    list.innerHTML = '';

    let sum = { value: 0, done: 0, iron: 0, check: 0, pass: 0, box: 0 };

    history
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .forEach((entry, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span><strong>${entry.date}:</strong> ${entry.value.toLocaleString()} sp</span>
                <small>
                    HT: ${entry.done || 0}, 
                    Ủi: ${entry.iron || 0}, 
                    Kiểm: ${entry.check || 0}, 
                    Đạt: ${entry.pass || 0}, 
                    ĐT: ${entry.box || 0}
                </small>
                <button class="btn-edit" data-index="${index}">🖊</button>
                <button class="btn-delete" data-index="${index}">🗑</button>
            `;
            list.appendChild(li);

            sum.value += entry.value || 0;
            sum.done += entry.done || 0;
            sum.iron += entry.iron || 0;
            sum.check += entry.check || 0;
            sum.pass += entry.pass || 0;
            sum.box += entry.box || 0;
        });

    // ✅ Gán tổng vào thẻ riêng
    const totalEl = document.getElementById('outputTotalValue');
    if (totalEl) {
        totalEl.innerHTML = `
            ${sum.value.toLocaleString()} sản phẩm |
            HT: ${sum.done} | Ủi: ${sum.iron} | Kiểm: ${sum.check} |
            Đạt: ${sum.pass} | ĐT: ${sum.box}
        `;
    }

    // 🗑 Xoá dòng
    list.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.index);
            if (confirm("Bạn có chắc muốn xoá dòng này?")) {
                outputs[taskKey][po].splice(index, 1);
                loadOutputHistory(itemId, season, po);
                updateTaskProgress(itemId, season, po);
                refreshTaskBarText(itemId, season, po);
            }
        });
    });

    // 🖊 Chỉnh sửa dòng → đẩy lại vào form
    list.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.index);
            const current = outputs[taskKey][po][index];

            document.getElementById('outputItemId').textContent = `${itemId}-${season}`;
            document.getElementById('outputPoSelect').value = po;
            document.getElementById('outputDate').value = current.date;
            document.getElementById('outputValue').value = current.value || 0;
            document.getElementById('outputDone').value = current.done || 0;
            document.getElementById('outputIron').value = current.iron || 0;
            document.getElementById('outputCheck').value = current.check || 0;
            document.getElementById('outputPass').value = current.pass || 0;
            document.getElementById('outputBox').value = current.box || 0;

            outputs[taskKey][po].splice(index, 1);
        });
    });
}






          document.querySelectorAll('.menu-option').forEach(btn => {
          btn.addEventListener('click', function () {
            const menu = document.getElementById('updateMenu');
            const itemId = menu?.dataset?.itemId;
            const season = menu?.dataset?.season;
            const po = menu?.dataset?.po;

            if (!itemId || !season || !po) {
              alert("⚠️ Không có thông tin mã hàng hợp lệ.");
              return;
            }

            const id = btn.id;

            if (id.includes('Production')) {
              openOderModal(itemId, season, po);
            }

            if (id.includes('Output') && !id.includes('Split')) {
              openOutputModal({ itemId, season, po });
            }

            if (id.includes('Split')) {
              openSplitSizeModal(itemId, season, po); // ✅ Gọi form
            }

            if (id.includes('Delivery')) {
              confirmDelivery(itemId, season, po);
            }

            if (id.includes('PreStep')) {
              openPreProductionSteps(itemId, season, po);
            }

            menu.style.display = 'none';
          });
        });



        function refreshTaskBarText(itemId, season, po) {
          const taskKey = `${itemId}-${season}`;
          const taskBarKey = `${itemId}-${po}`;

          // 🔍 Tìm task bar
          const taskBar = document.querySelector(`.task-bar[data-taskid="${taskBarKey}"]`);
          if (!taskBar) {
            console.warn(`⚠️ Không tìm thấy task bar: ${taskBarKey}`);
            return;
          }

          // 🧾 Lấy planQty từ dataset hoặc từ tasks
          const barQty = parseInt(taskBar.dataset.quantity);
          const task = tasks.find(t =>
            t.itemId === itemId &&
            t.season === season &&
            (Array.isArray(t.po) ? t.po.includes(po) : t.po === po)
          );
          const planQty = !isNaN(barQty) && barQty > 0
            ? barQty
            : parseInt(task?.quantity) || 0;

          // 📦 Lấy sản lượng (tổng value)
          const outputList = outputs[taskKey]?.[po] || [];
          const doneQty = outputList.reduce((sum, o) => sum + (parseInt(o.value) || 0), 0);
          const percent = planQty > 0 ? ((doneQty / planQty) * 100).toFixed(1) : "0.0";

          // 🧱 Tìm hoặc tạo .progress-text
          let progressEl = taskBar.querySelector('.progress-text');
          if (!progressEl) {
            progressEl = document.createElement('div');
            progressEl.className = 'progress-text';
            progressEl.style.cssText = `
              text-align: center;
              font-size: 13px;
              color: #874d00;
              font-weight: bold;
              margin-top: 4px;
            `;
            taskBar.appendChild(progressEl);
          }

          // 🆙 Cập nhật nội dung
          progressEl.textContent = `Sản lượng: ${doneQty} / ${planQty} (${percent}%)`;

          // ✅ Log kiểm tra
          console.debug(`📊 ${taskBarKey} → Done (value): ${doneQty} / Plan: ${planQty} (${percent}%)`);
        }





        function updateTaskProgress(itemId, season, po) {
            const taskKey = `${itemId}-${season}`;
            const taskBar = document.querySelector(`.task-bar[data-taskid="${itemId}-${po}"]`);
            if (!taskBar) return;

            const product = Producttail.find(p => p.itemId === itemId && p.season === season && p.po === po);
            if (!product) return;

            const quantityPlan = product.quantity;
            const totalDone = (outputs[taskKey] && outputs[taskKey][po])
                ? outputs[taskKey][po].reduce((sum, e) => sum + e.value, 0)
                : 0;

            const percent = Math.min(100, Math.round((totalDone / quantityPlan) * 100));

            const progressEl = taskBar.querySelector('.progress-bar');
            if (progressEl) {
                progressEl.style.width = `${percent}%`;
                progressEl.title = `${percent}% (${totalDone}/${quantityPlan})`;
            }
        }


            const itemsList={

            };

document.getElementById('btnShowNewTasks').addEventListener('click', () => {
  const modal = document.getElementById('newTasksModal');
  const tbody = document.querySelector('#newTasksTable tbody');
  tbody.innerHTML = '';

  const itemData = Array.isArray(window.itemsList) ? window.itemsList : [];
  const ganttKeys = new Set(
    (Array.isArray(window.tasks) ? window.tasks : [])
      .map(t => `${t.factory}-${t.itemId}-${t.po}`)
  );

  let count = 0;

  itemData.forEach(item => {
    const key = `${item.factory}-${item.itemId}-${item.po}`;
    if (!ganttKeys.has(key)) {
      // 🔍 Tìm từ waitsize để lấy số lượng
      const waitTask = waitTasks.find(w =>
      w.itemId === item.itemId &&
      w.season === item.season &&
      w.po === item.po
    );
    const totalQuantity = waitTask?.quantity || 0;

      // 👉 Ghi hàng vào bảng
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.itemId ?? ''}</td>
        <td>${item.season ?? ''}</td>
        <td>${item.po ?? ''}</td>
        <td>${totalQuantity}</td>
        <td>${item.NplDate ?? ''}</td>
        <td>${item.NgayGH ?? ''}</td>
        <td>${item.size ?? ''}</td>
      `;
      tbody.appendChild(tr);
      count++;

      // ✅ Gọi saveAdditionalPo cho mỗi dòng
      saveAdditionalPo({
        itemId: item.itemId,
        season: item.season,
        po: item.po,
        customer: item.customer,
        code: item.code,
        NplDate: item.NplDate,
        GhDate: item.NgayGH,
        groupsize: item.size
      });
    }
  });

  // Nếu không có mã hàng mới
  if (count === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="7" style="text-align:center; font-style:italic;">Không có mã hàng mới</td>`;
    tbody.appendChild(tr);
  }

  modal.style.display = 'block';
});


                                // Đóng modal 
                                document.getElementById('closeNewTasksModal').addEventListener('click', () => { 
                                document.getElementById('newTasksModal').style.display = 'none'; }); 

            // Đóng modal khi nhấn nút ❌
     
            document.getElementById('closeNewTasksModal').addEventListener('click', () => {
                document.getElementById('newTasksModal').style.display = 'none';
            });

function exportToExcel() {
  const normalized = normalizeTasks(tasks);
  const merged = mergeTaskWithProductAndTail(normalized, Product, Producttail, size);

  const dataA = [], dataB = [], progressA = [], progressB = [], sizeSheetA = [], sizeSheetB = [], waitProductSheet = [];

  // 1. Thông tin sản xuất
  merged.forEach(task => {
    const row = {
      Factory: task.Factory,
      Team: task.team,
      ItemID: task.itemId,
      Season: task.season,
      PO: task.po,
      Customer: task.customer,
      Code: task.code,
      productivity: task.productivity,
      Quantity: task.quantity,
      CM: task.cm,
      T: task.t,
      StartDate: task.startDate,
      EndDate: task.endDate,
      NPLDate: task.NplDate,
      GiaoHang: task.GhDate
    };
    if (task.Factory === "TH1") dataA.push(row);
    else if (task.Factory === "TH2") dataB.push(row);
  });

  // 2. Size chia theo khu (A/B) → dùng để tạo key kiểm tra
  const keySetA = new Set(dataA.map(row => `${row.ItemID}-${row.Season}-${row.PO}`));
  const keySetB = new Set(dataB.map(row => `${row.ItemID}-${row.Season}-${row.PO}`));

  // 3. Gom tất cả size từ size[] và waitsize[]
  const rawSizeSheet = [];

  size.forEach(entry => {
    entry.sizes?.forEach(s => {
      rawSizeSheet.push({
        ItemID: entry.itemId,
        Season: entry.season,
        PO: entry.po,
        Size: s.size,
        Quantity: s.quantity
      });
    });
  });

  waitsize.forEach(entry => {
    entry.sizes?.forEach(s => {
      rawSizeSheet.push({
        ItemID: entry.itemId,
        Season: entry.season,
        PO: entry.po,
        Size: s.size,
        Quantity: s.quantity
      });
    });
  });

  // 4. Làm sạch: xóa rỗng + xóa trùng
  const cleanedSizeSheet = rawSizeSheet.filter(row =>
  row.ItemID && row.Season && row.PO && row.Size &&
  row.Quantity != null && row.Quantity !== '' &&
  !isNaN(row.Quantity)
);

  const uniqueMap = new Map();
  cleanedSizeSheet.forEach(row => {
    const key = `${row.ItemID}-${row.Season}-${row.PO}-${row.Size}-${row.Quantity}`;
    uniqueMap.set(key, row);
  });

  const sizeSheet = Array.from(uniqueMap.values());

  // 5. Tách size theo khu A/B
  sizeSheet.forEach(row => {
    const key = `${row.ItemID}-${row.Season}-${row.PO}`;
    if (keySetA.has(key)) sizeSheetA.push(row);
    if (keySetB.has(key)) sizeSheetB.push(row);
  });

  // 6. Tiến độ sản xuất
  Object.entries(outputs).forEach(([taskKey, poMap]) => {
    const [itemId, season] = taskKey.split('-');
    Object.entries(poMap).forEach(([po, entries]) => {
      const task = tasks.find(t => t.itemId === itemId && t.season === season && (Array.isArray(t.po) ? t.po.includes(po) : t.po === po));
      const factory = task?.Factory || 'UNKNOWN';
      const team = task?.team || '';
      if (Array.isArray(entries)) {
        entries.forEach(entry => {
          const record = {
            Factory: factory,
            Team: team,
            ItemID: itemId,
            Season: season,
            PO: po,
            Date: entry.date,
            Output: entry.value || 0,
            Done: entry.done || 0,
            Iron: entry.iron || 0,
            Check: entry.check || 0,
            Pass: entry.pass || 0,
            Box: entry.box || 0
          };
          if (factory === "TH1") progressA.push(record);
          else if (factory === "TH2") progressB.push(record);
        });
      }
    });
  });

  // 7. WaitProduct
  waitTasks.forEach(task => {
    const row = {
      ItemID: task.itemId,
      Season: task.season,
      PO: task.po,
      Customer: task.customer,
      Code: task.code,
      Quantity: task.quantity,
      CM: task.cm,
      T: task.t,
      CMT: task.cmt,
      NPLDate: task.NplDate,
      GiaoHang: task.GhDate,
      GroupSize: task.groupsize
    };

    const waitEntry = waitsize.find(w => w.itemId === task.itemId && w.season === task.season && w.po === task.po);
    if (task.groupsize) {
      const group = Groupsize.find(g => g.groupsize === task.groupsize);
      group?.sizes?.forEach(s => {
        const sizeName = s.size;
        const sizeData = waitEntry?.sizes?.find(ss => ss.size === sizeName);
        row[sizeName] = sizeData?.quantity || 0;
      });
    }

    waitProductSheet.push(row);
  });

  // 8. GroupSize
  const groupsizeSheet = Groupsize.map(group => {
    const row = { Groupsizename: group.groupsize || group.Groupsizename || '' };
    const sizes = group.sizes || group.size || [];
    if (Array.isArray(sizes)) {
      sizes.forEach((s, i) => {
        const sizeValue = typeof s === 'string' ? s : s.size;
        row[`Size${i + 1}`] = sizeValue;
      });
    }
    return row;
  });

  // 9. FactoryData
  const factorySheet = [];
  FactoryData.forEach(factory => {
    factory.teams.forEach(team => {
      factorySheet.push({
        Factory: factory.Factory,
        Team: team.team,
        SLD: team.sld
      });
    });
  });

  // 10. Ghi file Excel
  const wb = XLSX.utils.book_new();
  const sheets = [
    { name: "Khu A - Factory A", data: dataA },
    { name: "Khu B - Factory B", data: dataB },
    { name: "Size Khu A", data: sizeSheetA },
    { name: "Size Khu B", data: sizeSheetB },
    { name: "Size Theo Điều Kiện", data: sizeSheet },
    { name: "Tiến độ Khu A", data: progressA },
    { name: "Tiến độ Khu B", data: progressB },
    { name: "WaitProduct", data: waitProductSheet },
    { name: "GroupSize", data: groupsizeSheet },
    { name: "FactoryData", data: factorySheet }
  ];

  sheets.forEach(({ name, data }) => {
    if (data.length) {
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, name);
    }
  });

  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const fileName = `Export_MaHang_${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}_${hh}${mm}.xlsx`;
  XLSX.writeFile(wb, fileName);
}




function importFullDataFromExcel() {
  const file = document.getElementById('excelImport').files[0];
  if (!file) return alert("❗ Vui lòng chọn file Excel!");

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });

    const requiredSheets = [
      "Khu A - Factory A", "Khu B - Factory B",
      "Size Khu A", "Size Khu B", "Size Theo Điều Kiện",
      "Tiến độ Khu A", "Tiến độ Khu B",
      "WaitProduct", "GroupSize", "FactoryData"
    ];

    requiredSheets.forEach(name => {
      if (!wb.Sheets[name]) console.warn(`⚠️ Sheet "${name}" không có trong file Excel.`);
    });

    // 🧹 Reset dữ liệu
    tasks.length = 0;
    Product.length = 0;
    Producttail.length = 0;
    size.length = 0;
    waitTasks.length = 0;
    waitsize.length = 0;
    waitgroupSizes.length = 0;
    Groupsize.length = 0;
    Object.keys(outputs).forEach(key => delete outputs[key]);

    // ✅ Load Tasks
    const allTasks = [];
    ["Khu A - Factory A", "Khu B - Factory B"].forEach(sheetName => {
      const sheet = wb.Sheets[sheetName];
      if (!sheet) return;
      const rows = XLSX.utils.sheet_to_json(sheet);
      allTasks.push(...rows);
    });

    allTasks.forEach(row => {
      tasks.push({
        Factory: row.Factory,
        team: row.Team,
        itemId: row.ItemID,
        season: row.Season,
        po: row.PO,
        status: "pending",
        productivity: row.productivity
      });

      Product.push({
        itemId: row.ItemID,
        season: row.Season,
        customer: row.Customer,
        code: row.Code,
        po: row.PO,
        startDate: formatIfExcelDate(row.StartDate),
        endDate: formatIfExcelDate(row.EndDate)
      });

      Producttail.push({
        itemId: row.ItemID,
        season: row.Season,
        po: row.PO,
        quantity: parseInt(row.Quantity),
        cm: parseFloat(row.CM),
        t: parseFloat(row.T),
        NplDate: row.NPLDate,
        GhDate: row.GiaoHang
      });
    });

    // ✅ Load Size từ Size Khu A + Khu B + Size Theo Điều Kiện
    const allSizeRows = [];
    ["Size Khu A", "Size Khu B", "Size Theo Điều Kiện"].forEach(name => {
      const sheet = wb.Sheets[name];
      if (sheet) {
        const rows = XLSX.utils.sheet_to_json(sheet);
        allSizeRows.push(...rows);
      }
    });

    const sizeMap = new Map();
    allSizeRows.forEach(row => {
      const key = `${row.ItemID}-${row.Season}-${row.PO}`;
      if (!sizeMap.has(key)) {
        sizeMap.set(key, {
          itemId: row.ItemID,
          season: row.Season,
          po: row.PO,
          sizes: []
        });
      }
      sizeMap.get(key).sizes.push({
        size: row.Size,
        quantity: parseInt(row.Quantity)
      });
    });
    size.push(...Array.from(sizeMap.values()));

    // ✅ Load Outputs
    ["Tiến độ Khu A", "Tiến độ Khu B"].forEach(sheetName => {
      const sheet = wb.Sheets[sheetName];
      if (!sheet) return;
      const rows = XLSX.utils.sheet_to_json(sheet);
      rows.forEach(row => {
        const key = `${row.ItemID}-${row.Season}`;
        const po = row.PO;
        if (!outputs[key]) outputs[key] = {};
        if (!outputs[key][po]) outputs[key][po] = [];
        outputs[key][po].push({
          date: row.Date,
          value: parseInt(row.Output) || 0,
          done: parseInt(row.Done) || 0,
          iron: parseInt(row.Iron) || 0,
          check: parseInt(row.Check) || 0,
          pass: parseInt(row.Pass) || 0,
          box: parseInt(row.Box) || 0
        });
      });
    });

    // ✅ Load WaitProduct
    const waitSheet = wb.Sheets["WaitProduct"];
    if (waitSheet) {
      const rows = XLSX.utils.sheet_to_json(waitSheet);
      const tempGroupSizes = {};

      rows.forEach(row => {
        const {
          ItemID, Season, PO, Customer, Code,
          Quantity, CM, T, CMT, NPLDate, GiaoHang, GroupSize,
          ...sizeCols
        } = row;

        const sizes = Object.entries(sizeCols)
          .filter(([_, qty]) => !isNaN(parseInt(qty)))
          .map(([size, qty]) => ({ size, quantity: parseInt(qty) }));

        waitTasks.push({
          itemId: ItemID,
          season: Season,
          po: PO,
          customer: Customer,
          code: Code,
          quantity: parseInt(Quantity),
          cm: parseFloat(CM),
          t: parseFloat(T),
          cmt: parseFloat(CMT),
          NplDate: NPLDate,
          GhDate: GiaoHang,
          groupsize: GroupSize
        });

        waitsize.push({
          itemId: ItemID,
          season: Season,
          po: PO,
          groupsize: GroupSize,
          quantity: parseInt(Quantity),
          customer: Customer,
          code: Code,
          NplDate: NPLDate,
          GhDate: GiaoHang,
          sizes
        });

        if (!tempGroupSizes[GroupSize]) tempGroupSizes[GroupSize] = {};
        sizes.forEach(({ size, quantity }) => {
          if (!tempGroupSizes[GroupSize][size]) {
            tempGroupSizes[GroupSize][size] = 0;
          }
          tempGroupSizes[GroupSize][size] += quantity;
        });
      });

      Object.entries(tempGroupSizes).forEach(([groupName, sizeMap]) => {
        const sizes = Object.entries(sizeMap).map(([size, quantity]) => ({ size, quantity }));
        waitgroupSizes.push({ groupsize: groupName, sizes });
      });

      // Bổ sung size nếu thiếu
      waitsize.forEach(waitRow => {
        if (!Array.isArray(waitRow.sizes) || waitRow.sizes.length === 0) {
          const match = size.find(s =>
            s.itemId === waitRow.itemId &&
            s.season === waitRow.season &&
            s.po === waitRow.po
          );
          if (match && Array.isArray(match.sizes)) {
            waitRow.sizes = match.sizes.map(s => ({ size: s.size, quantity: s.quantity || 0 }));
          }
        }
      });
    }

    // ✅ Load GroupSize
    const groupSizeSheet = wb.Sheets["GroupSize"];
    if (groupSizeSheet) {
      const rows = XLSX.utils.sheet_to_json(groupSizeSheet);
      rows.forEach(row => {
        const sizes = [];
        Object.keys(row).forEach(key => {
          if (key.startsWith("Size") && row[key]) {
            sizes.push(row[key]);
          }
        });
        if (row.Groupsizename && sizes.length > 0) {
          Groupsize.push({
            groupsize: row.Groupsizename,
            sizes
          });
        }
      });
    }

    if (Groupsize.length === 0 && waitgroupSizes.length > 0) {
      Groupsize.push(...waitgroupSizes);
    }

    // ✅ Load FactoryData
    const factorySheet = wb.Sheets["FactoryData"];
    if (factorySheet) {
      const rows = XLSX.utils.sheet_to_json(factorySheet);
      const temp = {};
      rows.forEach(row => {
        const { Factory, Team, SLD } = row;
        if (!temp[Factory]) temp[Factory] = [];
        temp[Factory].push({ team: Team, sld: parseInt(SLD) || 0 });
      });
      if (typeof FactoryData !== 'undefined') {
        FactoryData.length = 0;
        Object.entries(temp).forEach(([factoryName, teams]) => {
          FactoryData.push({ Factory: factoryName, teams });
        });
      }
    }

    // ✅ Cập nhật UI
    if (typeof renderSizeGroupOptions === 'function') {
      renderSizeGroupOptions();
    }

    if (document.getElementById('sizeGroupInput')) {
      document.getElementById('sizeGroupInput').value =
        Groupsize[0]?.groupsize || waitsize[0]?.groupsize || '';
      renderSizeTable();
    }

    alert("✅ Nhập đầy đủ dữ liệu từ Excel thành công!");
    const currentFactory = document.getElementById('factoryFilter').value;
    renderTasksByFactory(currentFactory);
  };

  reader.readAsArrayBuffer(file);
}



        function formatIfExcelDate(value) {
            if (typeof value === 'number') {
                const date = XLSX.SSF.parse_date_code(value);
                return `${String(date.d).padStart(2, '0')}/${String(date.m).padStart(2, '0')}/${date.y}`;
            }
            return value; // nếu đã đúng dạng chuỗi thì giữ nguyên
        }

        const updatedEndDates = []; // cấu trúc: [{ itemId, season, po, newEndDate }]

        tasksWithFullInfo = mergeTaskWithProductAndTail(tasks, Product, Producttail, size);
        function recalculateEndDate(itemId, season, po) {
          // Luôn luôn merge tại thời gian thực:
          const tasksWithFullInfo = mergeTaskWithProductAndTail(tasks, Product, Producttail, size);

          const task = tasksWithFullInfo.find(t =>
            t.itemId === itemId &&
            t.season === season &&
            (Array.isArray(t.po) ? t.po.includes(po) : t.po === po)
          );

          if (!task) {
            console.warn(`⚠️ Không tìm thấy mergedTask cho ${itemId}-${season}-${po}`);
            return;
          }

          const quantityPlan = task.quantity;
          const ns = calculatePro(task);

          const taskKey = `${itemId}-${season}`;
          const outputList = outputs[taskKey]?.[po];
          const quantityDone = outputList ? outputList.reduce((sum, e) => sum + e.value, 0) : 0;
          const remainQty = quantityPlan - quantityDone;

          if (ns <= 0 || remainQty <= 0) {
            console.log(`⏩ Bỏ qua tính endDate vì remainQty=${remainQty}, ns=${ns}`);
            return;
          }

          // 📆 Tính từ ngày bắt đầu task
          if (!task.startDate || typeof task.startDate !== 'string' || !task.startDate.includes('/')) {
          console.warn(`❌ task.startDate không hợp lệ:`, task.startDate);
          return;
        }

        const startDateParts = task.startDate.split('/'); // ["dd", "mm", "yyyy"]


          const startDate = new Date(`${startDateParts[2]}-${startDateParts[1]}-${startDateParts[0]}`);
          const workingDays = Math.ceil(remainQty / ns) - 1;
          const sundays = countSundays(startDate, workingDays);

          const newEnd = new Date(startDate);
          newEnd.setDate(newEnd.getDate() + workingDays + sundays);

          const formatDate = (date) => {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
          };

          const newEndDate = formatDate(newEnd);

          // 📋 Log kiểm tra
          console.log(`📌 [${itemId}-${season}-${po}]`);
          console.log(`👉 Plan: ${quantityPlan}, Done: ${quantityDone}, Remain: ${remainQty}`);
          console.log(`👉 NS: ${ns}, Workdays: ${workingDays}, Sundays: ${sundays}`);
          console.log(`📅 endDate hiện tại: ${task.endDate} → mới: ${newEndDate}`);

          if (task.endDate !== newEndDate) {
            console.log(`✅ Cập nhật endDate`);

            task.endDate = newEndDate;

            const product = Product.find(p =>
              p.itemId === itemId && p.season === season && p.po === po
            );
            if (product) product.endDate = newEndDate;

            const rawTask = tasks.find(t =>
              t.itemId === itemId && t.season === season && t.po === po
            );
            if (rawTask) rawTask.endDate = newEndDate;

            updatedEndDates.push({ itemId, season, po, newEndDate });

            // 🎯 Cập nhật Gantt bar
            const taskBar = document.querySelector(`.task-bar[data-taskid="${itemId}-${po}"]`);
            if (taskBar) {
              const pos = calculateTaskPosition(task.startDate, task.endDate);
              taskBar.style.width = `${pos.width}px`;

              const [startShort, endShort] = [
                task.startDate.split('/').slice(0, 2).join('/'),
                task.endDate.split('/').slice(0, 2).join('/')
              ];

              const dateElements = taskBar.querySelectorAll('.task-date');
              if (dateElements[0]) dateElements[0].textContent = `${startShort} - ${endShort}`;
              if (dateElements[1]) dateElements[1].textContent = `${Math.round(pos.width / 30)} ngày`;
            }
          } else {
            console.log(`⏩ Không cần cập nhật endDate (giống cũ)`);
          }
        }


        function adjustStartDatesByTeam(factory) {
            const normalized = normalizeTasks(tasks);
            const enriched = mergeTaskWithProductAndTail(normalized, Product, Producttail);

            const groupedByTeam = {};

            // Bước 1: Gom theo team trong cùng factory
            enriched.forEach(task => {
                if (task.Factory !== factory) return;
                if (!groupedByTeam[task.team]) groupedByTeam[task.team] = [];
                groupedByTeam[task.team].push(task);
            });

            // Bước 2: Xử lý từng team
            Object.keys(groupedByTeam).forEach(team => {
                console.log(`🧵 Bắt đầu xử lý team: ${team}`);

                const teamTasks = groupedByTeam[team].sort((a, b) => {
                    const d1 = new Date(a.startDate.split('/').reverse().join('/'));
                    const d2 = new Date(b.startDate.split('/').reverse().join('/'));
                    return d1 - d2;
                });

                // Log trước update
                for (const task of teamTasks) {
                    console.log(`📌 Trước update [${task.po}] - start: ${task.startDate}, end: ${task.endDate}`);
                }

                for (let i = 1; i < teamTasks.length; i++) {
                    const prev = teamTasks[i - 1];
                    const curr = teamTasks[i];

                    // Tính new start = end của task trước + 1
                    const prevEnd = new Date(prev.endDate.split('/').reverse().join('/'));
                    const newStart = new Date(prevEnd);
                    newStart.setDate(newStart.getDate() + 1);
                    const formattedStart = formatDate(newStart);

                    // Gán start mới + tính lại endDate theo năng suất
                    curr.startDate = formattedStart;
                    curr.endDate = estimateEndDateByNs(curr);

                    console.log(`🔁 Đã cập nhật ${curr.po}: start = ${curr.startDate}, end = ${curr.endDate}`);

                    // ✅ Ghi lại vào Product
                    const idx = Product.findIndex(p =>
                        p.itemId === curr.itemId &&
                        p.season === curr.season &&
                        p.po === curr.po
                    );
                    if (idx >= 0) {
                        Product[idx].startDate = curr.startDate;
                        Product[idx].endDate = curr.endDate;
                    }

                    // ✅ Ghi lại vào tasks[] nếu cần
                    const taskIdx = tasks.findIndex(t =>
                        t.itemId === curr.itemId &&
                        t.season === curr.season &&
                        t.po === curr.po
                    );
                    if (taskIdx >= 0) {
                        tasks[taskIdx].startDate = curr.startDate;
                    }
                }

                // Log sau cập nhật
                for (const task of teamTasks) {
                    console.log(`✅ Sau update [${task.po}] - start: ${task.startDate}, end: ${task.endDate}`);
                }
            });

            // Bước 3: Đồng bộ hiển thị
            tasksWithFullInfo = mergeTaskWithProductAndTail(tasks, Product, Producttail, size);
        }








        function estimateEndDateByNs(task) {
          const ns = calculatePro(task);
          if (!task.startDate || !task.quantity || ns <= 0) {
            console.warn("⚠️ Không thể tính ngày kết thúc:", task);
            return '';
          }

          const parseDate = (str) => {
            if (!str || typeof str !== 'string' || !str.includes('/')) {
              console.warn("❗ parseDate() nhận giá trị không hợp lệ:", str);
              return null;
            }
            const [d, m, y] = str.split('/').map(Number);
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            const date = new Date(y, m - 1, d);
            date.setHours(0, 0, 0, 0);
            return date;
          };

          const formatDate = (date) => {
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
          };

          const startDate = parseDate(task.startDate);
          if (!startDate) {
            console.warn("❗ Không thể parse ngày bắt đầu:", task.startDate);
            return '';
          }

          const totalDays = Math.ceil(task.quantity / ns) - 1;
          let dayCount = 0;
          const current = new Date(startDate);

          while (dayCount < totalDays) {
            current.setDate(current.getDate() + 1);
            if (current.getDay() !== 0) dayCount++; // Bỏ qua Chủ Nhật
          }

          return formatDate(current);
        }


        document.getElementById("btnReports").addEventListener("click", function (e) {
          const menu = document.getElementById("reportMenu");
          menu.style.display = menu.style.display === "none" ? "block" : "none";
          menu.style.left = `${e.pageX}px`;
          menu.style.top = `${e.pageY}px`;
        });
function generateTeamProgressReport(factory) {
  currentFactoryInReport = factory;
  const normalized = normalizeTasks(tasks);
  const merged = mergeTaskWithProductAndTail(normalized, Product, Producttail);

  const selectedCustomer = document.getElementById('customerFilterSelect')?.value || '';

  // 👉 Tập hợp danh sách customer theo factory
  const customers = new Set();
  merged.forEach(task => {
    if (task.Factory === factory && task.customer) {
      customers.add(task.customer);
    }
  });

  // 👉 Cập nhật dropdown customer nếu có
  const select = document.getElementById('customerFilterSelect');
  if (select) {
    const current = select.value;
    select.innerHTML = `<option value="">-- Tất cả --</option>`;
    Array.from(customers).sort().forEach(cus => {
      const opt = document.createElement('option');
      opt.value = cus;
      opt.textContent = cus;
      if (cus === current) opt.selected = true;
      select.appendChild(opt);
    });
  }

  // 🧩 Gom theo chuyền
  const teamMap = {};

  merged.forEach(task => {
    if (task.Factory !== factory) return;
    if (selectedCustomer && task.customer !== selectedCustomer) return;

    const key = task.team;
    if (!teamMap[key]) teamMap[key] = [];

    const taskKey = `${task.itemId}-${task.season}`;
    const outputList = outputs[taskKey]?.[task.po];
    const quantity = task.quantity || 0;

    let sum = { value: 0, done: 0, iron: 0, check: 0, pass: 0, box: 0 };
    if (outputList) {
      outputList.forEach(e => {
        sum.value += e.value || 0;
        sum.done += e.done || 0;
        sum.iron += e.iron || 0;
        sum.check += e.check || 0;
        sum.pass += e.pass || 0;
        sum.box += e.box || 0;
      });
    }

     teamMap[key].push({
      team: task.team,
      itemSeason: `${task.itemId}-${task.season}`,
      po: task.po,
      quantity,
      totalOutput: sum.value,
      totalDone: sum.done,
      backlog: sum.value - sum.done,
      totalIron: sum.iron,
      backlogIron: sum.done - sum.iron,
      totalCheck: sum.check,
      totalPass: sum.pass,
      error: sum.check - sum.pass,
      totalBox: sum.box
    });
  });

  // 🧾 Render bảng
  let html = `
    <table class="report-table">
      <thead>
        <tr>
          <th>Chuyền</th>
          <th>MÃ HàNG - Season</th>
          <th>PO</th>
          <th>Số lượng</th>
          <th>Tổng Output</th>
          <th>Nhập HT</th>
          <th>Tồn chuyền</th>
          <th>Ủi</th>
          <th>Ứ Ủi</th>
          <th>Kiểm</th>
          <th>Đạt</th>
          <th>Hư</th>
          <th>Đóng thùng</th>
        </tr>
      </thead>
      <tbody>
  `;

  const totalFactory = {
    quantity: 0, totalOutput: 0, totalDone: 0, backlog: 0,
    totalIron: 0, backlogIron: 0, totalCheck: 0,
    totalPass: 0, error: 0, totalBox: 0
  };

 Object.keys(teamMap).forEach(team => {
  const records = teamMap[team];
  let total = {
    quantity: 0, totalOutput: 0, totalDone: 0, backlog: 0,
    totalIron: 0, backlogIron: 0, totalCheck: 0,
    totalPass: 0, error: 0, totalBox: 0
  };

  records.forEach((r, idx) => {
    html += `<tr>`;
    if (idx === 0) {
      html += `<td rowspan="${records.length}">${team}</td>`;
    }
    html += `
      <td>${r.itemSeason}</td>
      <td>${r.po}</td>
      <td>${r.quantity}</td>
      <td>${r.totalOutput}</td>
      <td>${r.totalDone}</td>
      <td>${r.backlog}</td>
      <td>${r.totalIron}</td>
      <td>${r.backlogIron}</td>
      <td>${r.totalCheck}</td>
      <td>${r.totalPass}</td>
      <td>${r.error}</td>
      <td>${r.totalBox}</td>
    </tr>`;

    // Tính tổng
    Object.keys(total).forEach(k => total[k] += r[k]);
  });

  // TỔNG chuyền
  html += `
    <tr class="report-total">
      <td colspan="3"><strong>TỔNG ${team}</strong></td>
      <td>${total.quantity}</td>
      <td>${total.totalOutput}</td>
      <td>${total.totalDone}</td>
      <td>${total.backlog}</td>
      <td>${total.totalIron}</td>
      <td>${total.backlogIron}</td>
      <td>${total.totalCheck}</td>
      <td>${total.totalPass}</td>
      <td>${total.error}</td>
      <td>${total.totalBox}</td>
    </tr>
  `;

  Object.keys(total).forEach(k => totalFactory[k] += total[k]);
});


  // Tổng khu
  html += `
    <tr class="report-factory-total">
      <td colspan="3"><strong>TỔNG KHU ${factory}</strong></td>
      <td>${totalFactory.quantity}</td>
      <td>${totalFactory.totalOutput}</td>
      <td>${totalFactory.totalDone}</td>
      <td>${totalFactory.backlog}</td>
      <td>${totalFactory.totalIron}</td>
      <td>${totalFactory.backlogIron}</td>
      <td>${totalFactory.totalCheck}</td>
      <td>${totalFactory.totalPass}</td>
      <td>${totalFactory.error}</td>
      <td>${totalFactory.totalBox}</td>
    </tr>
  `;

  html += `</tbody></table>`;
  document.getElementById("reportResult").innerHTML = html;
  document.getElementById("reportModal").style.display = "block";
}




        function closeReportModal() {
          document.getElementById("reportModal").style.display = "none";
        }
        // Đóng khi click ra ngoài
        document.addEventListener('click', function (e) {
            const menu = document.getElementById('reportMenu');
            const btn = document.getElementById('btnReports');
            if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // Đóng khi nhấn ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const menu = document.getElementById('reportMenu');
                if (menu) menu.style.display = 'none';
            }
        });


        document.getElementById("btnShowNewTasks").addEventListener("click", () => {
          document.getElementById("newTasksModal").style.display = "flex";
        });

        document.querySelector('#newTasksModal button').addEventListener("click", () => {
          openNewProductModal(); // ✅ Mở modal nhập mã mới
        });


        document.getElementById('btnShowNewTasks')?.addEventListener('click', () => {
          loadAvailableTasks();
        });
        function closeNewProductModal() {
          document.getElementById('modalNewProduct').style.display = 'none';

          // Reset các tab
          document.querySelectorAll('#modalNewProduct .tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('#modalNewProduct .tab-content').forEach(tab => tab.classList.remove('active'));

          // Đặt tab mặc định là tab đầu
          document.querySelector('#modalNewProduct .tab-btn[data-tab="productInfoTab"]').classList.add('active');
          document.getElementById('productInfoTab').classList.add('active');

          // Reset form (tuỳ chọn)
          document.querySelectorAll('#modalNewProduct input').forEach(input => input.value = '');
          document.querySelector('#newSizeTable tbody').innerHTML = '';
        }
        function openNewProductModal() {
          document.getElementById("modalNewProduct").style.display = "flex";

          // Đặt tab đầu tiên là active khi mở
          switchTab('productInfoTab');
        }

        function switchTab(tabId) {
          // Ẩn tất cả tab và bỏ active
          document.querySelectorAll('#modalNewProduct .tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('#modalNewProduct .tab-content').forEach(tab => tab.classList.remove('active'));

          // Bật tab mới
          const newBtn = document.querySelector(`#modalNewProduct .tab-btn[data-tab="${tabId}"]`);
          const newTab = document.getElementById(tabId);

          if (newBtn && newTab) {
            newBtn.classList.add('active');
            newTab.classList.add('active');
          }
            if (tabId === 'productInfoTab') {
            const itemId = document.getElementById("newItemId").value;
            const season = document.getElementById("newSeason").value;
            const po = document.getElementById("newPo").value;
            loadSizeToNewSizeTable(itemId, season, po);
          }

        }
        function updateCMT() {
          const cm = parseFloat(document.getElementById('inputCm').value) || 0;
          const t = parseFloat(document.getElementById('inputT').value) || 0;
          const cmt = cm + t;

          document.getElementById('inputCmt').value = cmt.toFixed(2);
        }

        // 2. Tạo danh sách option trong dropdown
        function renderSizeGroupOptions() {
          const datalist = document.getElementById('sizeGroups');
          datalist.innerHTML = '';

          Groupsize.forEach(group => {
            const option = document.createElement('option');
            option.value = group.groupsize; // ✅ sửa đúng tên thuộc tính
            datalist.appendChild(option);
          });

          // Tự động điền giá trị đầu tiên và vẽ bảng size
          if (Groupsize.length > 0) {
            document.getElementById('sizeGroupInput').value = Groupsize[0].groupsize;
            renderSizeTable();
          }
        }




        // 3. Vẽ bảng size dựa vào nhóm đã chọn
           function renderSizeTable() {
  const selectedGroup = document.getElementById('sizeGroupInput').value.trim();
  const group = Groupsize.find(g => g.groupsize === selectedGroup);
  const tbody = document.querySelector('#newSizeTable tbody');
  tbody.innerHTML = '';

  if (!group || !Array.isArray(group.sizes)) {
    tbody.innerHTML = `<tr><td colspan="2" class="text-danger">❗ Nhóm size không hợp lệ</td></tr>`;
    return;
  }

  // ✅ Chuẩn hóa: chuyển string thành object { size: "..." }
  const normalizedSizes = group.sizes
    .filter(s => s) // loại undefined/null
    .map(s => typeof s === 'string' ? { size: s } : s);

  if (normalizedSizes.length === 0) {
    tbody.innerHTML = `<tr><td colspan="2" class="text-muted">Không có size trong nhóm</td></tr>`;
    return;
  }

  normalizedSizes.forEach(sizeObj => {
    const sizeName = sizeObj.size || '❓';

    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="vertical-align: middle;">${sizeName}</td>
      <td>
        <input type="number" min="0" value="0" 
               data-size="${sizeName}" 
               class="form-control form-control-sm"
               style="max-width: 120px;" />
      </td>
    `;
    tbody.appendChild(row);
  });
}


function loadSizeToNewSizeTable() {
  const itemId = document.getElementById("newItemId").value.trim();
  const season = document.getElementById("newSeason").value.trim();
  const po = document.getElementById("newPo").value.trim();

  console.log("📥 Đang load size tab với:", { itemId, season, po });

  if (!itemId || !season || !po) {
    console.warn("⚠️ Thiếu itemId/season/po để load size.");
    return;
  }

  const sizeEntry = waitsize.find(s =>
    s.itemId === itemId && s.season === season && s.po === po
  );

  if (!sizeEntry) {
    console.log("❌ Không tìm thấy dữ liệu trong waitsize.");
    return;
  }

  const group = Groupsize.find(g => g.groupsize === sizeEntry.groupsize);
  if (!group) {
    console.warn("❌ Không tìm thấy nhóm size tương ứng trong Groupsize");
    return;
  }

  // 🔁 Chuẩn hóa group.sizes (phòng trường hợp là chuỗi)
  group.sizes = group.sizes
    .filter(s => s)
    .map(s => typeof s === 'string' ? { size: s } : s);

  const tbody = document.querySelector('#newSizeTable tbody');
  tbody.innerHTML = '';

  group.sizes.forEach(sz => {
    const existing = sizeEntry.sizes?.find(s => s.size === sz.size);
    const quantity = existing ? existing.quantity : 0;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="vertical-align: middle;">${sz.size}</td>
      <td>
        <input type="number" min="0" value="${quantity}" 
               data-size="${sz.size}" 
               class="form-control form-control-sm"
               style="max-width: 120px;" />
      </td>
    `;
    tbody.appendChild(row);
  });
}




        // 4. Gọi khi DOM đã sẵn sàng
        document.addEventListener('DOMContentLoaded', function () {
          renderSizeGroupOptions(); // 👈 GỌI TẠI ĐÂY
        });

        function openNewProductModal() {
          const modal = document.getElementById('modalNewProduct');
          if (!modal) return;

          modal.style.display = 'flex';

          // ✅ Reset tất cả các ô input trong modal
          modal.querySelectorAll('input').forEach(input => input.value = '');

          // ✅ Reset input nhóm size (đúng ID là "sizeGroupInput", không phải "sizeGroupSelect")
          const sizeInput = document.getElementById('sizeGroupInput');
          if (sizeInput) sizeInput.value = '';

          // ✅ Reset bảng size
          const sizeTableBody = document.querySelector('#newSizeTable tbody');
          if (sizeTableBody) sizeTableBody.innerHTML = '';

          // ✅ Gọi lại render bảng size (nếu có function)
          if (typeof renderSizeTable === 'function') renderSizeTable();

          // ✅ Hiện nút "Lưu mã mới", ẩn nút "Lưu mã hàng"
          const saveNewBtn = document.querySelector('button[onclick="saveNewProduct()"]');
          if (saveNewBtn) saveNewBtn.style.display = 'inline-block';

          const savePOBtn = document.getElementById('btnSaveAdditionalPO');
          if (savePOBtn) savePOBtn.style.display = 'none';

          // ✅ Đặt lại tab mặc định về "Thông tin sản phẩm"
          switchTab('productInfoTab');

        }

        function saveNewProduct() {
          const itemId = document.getElementById('newItemId').value.trim();
          const season = document.getElementById('newSeason').value.trim();
          const po = document.getElementById('newPo').value.trim();
          const customer = document.getElementById('newCustomer').value.trim();
          const code = document.getElementById('newCode').value.trim();
          const NplDate = document.getElementById('newNplDate').value;
          const GhDate = document.getElementById('newGhDate').value;
          const cm = parseFloat(document.getElementById('inputCm').value) || 0;
          const t = parseFloat(document.getElementById('inputT').value) || 0;
          const cmt = cm + t;
          const groupSizeName = document.getElementById('sizeGroupInput').value.trim();

          const sizeRows = document.querySelectorAll("#newSizeTable tbody tr");
        const sizes = [...sizeRows].map(row => {
          const size = row.querySelector('td:first-child')?.textContent.trim();
          const quantity = parseInt(row.querySelector('td:nth-child(2) input')?.value) || 0;
          return { size, quantity };
        }).filter(s => s.size && s.quantity > 0);


          const quantity = sizes.reduce((sum, s) => sum + s.quantity, 0);

          // ❗ Cảnh báo nếu chưa nhập size hoặc số lượng
          if (!groupSizeName) {
            alert("❗ Bạn chưa chọn nhóm size.");
            return;
          }
          if (sizes.length === 0 || quantity === 0) {
            alert("❗ Bạn chưa nhập số lượng cho các size.");
            return;
          }

          // 🔍 Kiểm tra trùng
          const key = `${itemId}-${season}-${po}`;
          const exists = waitTasks.some(task => `${task.itemId}-${task.season}-${task.po}` === key);
          if (exists) {
            alert("❗ Mã hàng này đã tồn tại trong danh sách chờ.");
            return;
          }

          // ✅ Ghi vào waitTasks
          waitTasks.push({
            itemId, season, po, customer, code,
            NplDate, GhDate,
            quantity, cm, t, cmt
          });

          // ✅ Ghi vào waitsize
         waitsize.push({ itemId, season, po, groupsize: groupSizeName, quantity, sizes });


          // ✅ Ghi vào waitgroupSizes
          const existingGroupIndex = waitgroupSizes.findIndex(g => g.groupsize === groupSizeName);
          if (existingGroupIndex >= 0) {
            waitgroupSizes[existingGroupIndex].sizes = sizes;
          } else {
            waitgroupSizes.push({ groupsize: groupSizeName, sizes });
          }

          console.log("✅ Đã lưu mã mới:", {
            itemId, season, po, groupSizeName, quantity, sizes
          });

          document.getElementById('modalNewProduct').style.display = 'none';
          loadAvailableTasks();
        }

function saveAdditionalPo() {
  const itemId = document.getElementById('newItemId').value.trim();
  const season = document.getElementById('newSeason').value.trim();
  const po = document.getElementById('newPo').value.trim();
  const customer = document.getElementById('newCustomer').value.trim();
  const code = document.getElementById('newCode').value.trim();
  const NplDate = document.getElementById('newNplDate').value;
  const GhDate = document.getElementById('newGhDate').value;
  const cm = parseFloat(document.getElementById('inputCm').value);
  const t = parseFloat(document.getElementById('inputT').value);
  const cmt = parseFloat(document.getElementById('inputCmt').value);
  const groupSizeName = document.getElementById('sizeGroupInput').value.trim();

  // 🔄 Lấy lại size & quantity từ bảng nhập
  const sizeRows = document.querySelectorAll('#newSizeTable tbody tr');
  const sizes = [...sizeRows].map(row => {
    const size = row.querySelector('td:first-child')?.textContent.trim();
    const input = row.querySelector('td:nth-child(2) input');
    const quantity = input && input.value !== '' ? parseInt(input.value) : 0;
    return { size, quantity };
  }).filter(s => s.size && s.quantity > 0);

  const quantity = sizes.reduce((sum, s) => sum + s.quantity, 0);

  if (!itemId || !season || !po || quantity <= 0) {
    alert("⚠️ Thiếu thông tin hoặc chưa nhập số lượng hợp lệ.");
    console.warn("❗ Debug thêm:", { itemId, season, po, quantity, sizes });
    return;
  }

  const key = `${itemId}-${season}-${po}`;

  // 📝 Ghi vào waitTasks
  const taskData = {
    itemId, season, po,
    customer, code,
    NplDate, GhDate,
    quantity, cm, t, cmt,
    groupsize: groupSizeName
  };

  const existingTaskIndex = waitTasks.findIndex(t => `${t.itemId}-${t.season}-${t.po}` === key);
  if (existingTaskIndex >= 0) {
    waitTasks[existingTaskIndex] = taskData;
  } else {
    waitTasks.push(taskData);
  }

  // 📝 Ghi vào waitsize
  const sizeData = {
    itemId, season, po,
    customer, code,
    NplDate, GhDate,
    quantity, groupsize: groupSizeName,
    sizes
  };
  const existingSizeIndex = waitsize.findIndex(t => `${t.itemId}-${t.season}-${t.po}` === key);
  if (existingSizeIndex >= 0) {
    waitsize[existingSizeIndex] = sizeData;
  } else {
    waitsize.push(sizeData);
  }

  // 📝 Ghi vào waitgroupSizes
  if (groupSizeName && sizes.length > 0) {
    const existingGroupIndex = waitgroupSizes.findIndex(g => g.groupsize === groupSizeName);
    const groupEntry = { groupsize: groupSizeName, sizes: sizes.map(s => ({ size: s.size })) };

    if (existingGroupIndex >= 0) {
      waitgroupSizes[existingGroupIndex] = groupEntry;
    } else {
      waitgroupSizes.push(groupEntry);
    }
  }

  console.log("✅ Đã cập nhật hoặc thêm PO vào hàng đợi:", {
    itemId, season, po, groupSizeName, quantity
  });

  document.getElementById('modalNewProduct').style.display = 'none';
  loadAvailableTasks();
}


        function deleteAdditionalPo() {
          const itemId = document.getElementById('newItemId').value.trim();
          const season = document.getElementById('newSeason').value.trim();
          const po = document.getElementById('newPo').value.trim();

          if (!itemId || !season || !po) {
            alert("❗ Không thể xác định PO để xoá.");
            return;
          }

          const key = `${itemId}-${season}-${po}`;

          if (!confirm(`Bạn có chắc muốn xoá PO "${po}" của mã hàng "${itemId}" không?`)) {
            return;
          }

          // ❌ Xoá khỏi waitTasks
          const indexTask = waitTasks.findIndex(t => `${t.itemId}-${t.season}-${t.po}` === key);
          if (indexTask >= 0) waitTasks.splice(indexTask, 1);

          // ❌ Xoá khỏi waitsize
          const indexSize = waitsize.findIndex(t => `${t.itemId}-${t.season}-${t.po}` === key);
          if (indexSize >= 0) waitsize.splice(indexSize, 1);

          // ❌ KHÔNG xoá waitgroupSizes vì có thể còn PO khác dùng cùng groupsize

          console.log("🗑 Đã xoá PO:", key);
          document.getElementById('modalNewProduct').style.display = 'none';
          loadAvailableTasks();
        }


        function convertDDMMYYYYtoISO(dateStr) {
          if (!dateStr || typeof dateStr !== 'string' || !dateStr.includes('/')) return dateStr;
          const [d, m, y] = dateStr.split('/');
          return `${y}-${m}-${d}`;
        }

function openNewProductModalWithData(data) {
  openNewProductModal(); // reset modal

  const itemId = data.itemId || '';
  const season = data.season || '';
  const Po = data.Po || data.po || '';

  const waitInfo = waitTasks.find(w =>
    w.itemId === itemId && w.season === season && w.po === Po
  ) || {};

  const customer = data.customer ?? waitInfo.customer ?? '';
  const code = data.code ?? waitInfo.code ?? '';
  const NplDateRaw = data.NplDate ?? waitInfo.NplDate ?? '';
  const GhDateRaw = data.GhDate ?? waitInfo.GhDate ?? '';
  const cm = data.cm ?? waitInfo.cm ?? '';
  const t = data.t ?? waitInfo.t ?? '';
  const cmt = data.cmt ?? waitInfo.cmt ?? '';
  const groupsize = data.groupsize ?? waitInfo.groupsize ?? '';

  console.log("📦 waitTasks:", waitInfo);

  // ✅ Gán dữ liệu vào form
  document.getElementById('newItemId').value = itemId;
  document.getElementById('newSeason').value = season;
  document.getElementById('newPo').value = Po;
  document.getElementById('newCustomer').value = customer;
  document.getElementById('newCode').value = code;
  document.getElementById('newNplDate').value = convertDDMMYYYYtoISO(NplDateRaw);
  document.getElementById('newGhDate').value = convertDDMMYYYYtoISO(GhDateRaw);
  document.getElementById('inputCm').value = cm;
  document.getElementById('inputT').value = t;
  document.getElementById('inputCmt').value = cmt;
  document.getElementById('sizeGroupInput').value = groupsize;

  // ✅ Load nhóm size từ Groupsize hoặc waitsize
  let group = Groupsize.find(g => g.groupsize === groupsize);

  if (!group || !Array.isArray(group.sizes)) {
    const waitsizeEntry = waitsize.find(w =>
      w.itemId === itemId && w.season === season && w.po === Po
    );
    if (waitsizeEntry) {
      group = { sizes: waitsizeEntry.sizes || [] };
    }
  }

  // ✅ Chuẩn hóa mảng size
  if (group && Array.isArray(group.sizes)) {
    group.sizes = group.sizes
      .filter(s => s) // bỏ null/undefined
      .map(s => typeof s === 'string' ? { size: s } : s);
  }

  console.log("📦 Nhóm size tìm được:", group);

  // ✅ Vẽ bảng size
  const tbody = document.querySelector('#newSizeTable tbody');
  tbody.innerHTML = '';

  if (group && Array.isArray(group.sizes) && group.sizes.length > 0) {
    group.sizes.forEach(size => {
      const sizeName = size.size;
      const quantity = size.quantity || 0;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${sizeName}</td>
        <td><input type="number" value="${quantity}" min="0" style="width: 100%; padding: 4px;" /></td>
      `;
      tbody.appendChild(row);
    });
  } else {
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="2" style="text-align:center;color:#999;">Không có size</td>`;
    tbody.appendChild(row);
  }

  // ✅ Hiện các nút xử lý PO
  const btnNew = document.querySelector('button[onclick="saveNewProduct()"]');
  if (btnNew) btnNew.style.display = 'none';

  const btnPO = document.getElementById('btnSaveAdditionalPO');
  if (btnPO) btnPO.style.display = 'inline-block';

  const btnDel = document.getElementById('btnDeleteAdditionalPO');
  if (btnDel) btnDel.style.display = 'inline-block';

  // ✅ Mở tab thông tin chính
  switchTab('productInfoTab');
}




        function loadAvailableTasks() {
          const tbody = document.querySelector('#newTasksTable tbody');
          tbody.innerHTML = '';

          const itemData = Array.isArray(window.itemsList) ? window.itemsList : [];
          const taskData = [...itemData, ...newTasks, ...waitTasks];

          const ganttKeys = new Set((Array.isArray(window.tasks) ? window.tasks : []).map(
            t => `${t.itemId}-${t.season}-${t.po}`
          ));

          const seen = new Set();
          const uniqueTasks = [];

          taskData.forEach(task => {
            const itemId = task.itemId;
            const season = task.season;
            const Po = task.po || task.Po;
            const key = `${itemId}-${season}-${Po}`;

            if (!ganttKeys.has(key) && !seen.has(key)) {
              seen.add(key);
              uniqueTasks.push({ ...task, Po });
            }
          });

          if (uniqueTasks.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="8" style="text-align: center; color: #999;">Dữ liệu trống</td>`;
            tbody.appendChild(tr);
            document.getElementById('newTasksModal').style.display = 'flex';
            return;
          }

          // 🔍 Đoán nhóm size nếu không có
          function guessGroupSizeFromSizes(sizesArray) {
            if (!Array.isArray(sizesArray) || sizesArray.length === 0) return null;

            const sizeNames = sizesArray.map(sz => typeof sz === 'string' ? sz : sz.size);
            const allGroups = [...Groupsize, ...waitgroupSizes];

            return allGroups.find(group => {
              const gSizes = group.sizes || [];
              const gSizeNames = gSizes.map(sz => typeof sz === 'string' ? sz : sz.size);
              return gSizeNames.length === sizeNames.length &&
                     gSizeNames.every(sz => sizeNames.includes(sz));
            })?.groupsize || null;
            }

            uniqueTasks.forEach(task => {
            const itemId = task.itemId;
            const season = task.season;
            const Po = task.Po;
            if (!itemId || !season || !Po) return;

            const sizeInfo = waitsize.find(w =>
              w.itemId === itemId && w.season === season && w.po === Po
            );

            let groupSizeName =
              sizeInfo?.groupsize ||
              task.groupsize ||
              guessGroupSizeFromSizes(task.sizes) ;

            const group =
              waitgroupSizes.find(g => g.groupsize === groupSizeName) ||
              Groupsize.find(g => g.Groupsizename === groupSizeName);

            // 🔧 Tính lại số lượng từ size nếu cần
            let Quantity = task.Quantity || task.quantity || sizeInfo?.quantity || 0;
            if ((!Quantity || Quantity === 0) && Array.isArray(group?.sizes)) {
              Quantity = group.sizes.reduce((sum, sz) => {
                const qty = typeof sz === 'object' ? sz.quantity || 0 : 0;
                return sum + qty;
              }, 0);
            }

            const NplDate = task.NplDate || task.NgayNPL || '';
            const GhDate = task.GhDate || task.NgayGH || '';

            // ✅ Sửa lỗi sizeText undefined
            const sizeText = group?.groupsize || group?.Groupsizename || groupSizeName ;

            const tr = document.createElement('tr');
            tr.dataset.itemId = itemId;
            tr.dataset.season = season;
            tr.dataset.po = Po;

            tr.innerHTML = `
              <td>${itemId}</td>
              <td>${season}</td>
              <td>${Po}</td>
              <td>${Quantity}</td>
              <td>${NplDate || '—'}</td>
              <td>${GhDate || '—'}</td>
              <td>${sizeText}</td>
              <td><button onclick="acceptToGantt('${itemId}', '${season}', '${Po}')">✅ Gantt</button></td>
            `;

            // 👆 Cho phép sửa lại bằng double click
            tr.addEventListener('dblclick', () => {
              const info = waitTasks.find(t =>
                t.itemId === itemId && t.season === season && t.po === Po
              ) || {};

              openNewProductModalWithData({
                itemId,
                season,
                Po,
                customer: info.customer || task.customer || '',
                code: info.code || task.code || '',
                NplDate,
                GhDate,
                Quantity,
                cm: info.cm || task.cm || '',
                t: info.t || task.t || '',
                cmt: info.cmt || task.cmt || '',
                groupsize: groupSizeName,
                sizes: Array.isArray(group?.sizes)
                  ? group.sizes.map(sz => ({
                      size: typeof sz === 'string' ? sz : sz.size,
                      quantity: typeof sz === 'object' ? sz.quantity ?? 0 : 0
                    }))
                  : []
              });
            });

            tbody.appendChild(tr);
          });

          document.getElementById('newTasksModal').style.display = 'flex';
        }



        function selectFactoryFromData() {
          const factoryList = FactoryData.map(f => f.Factory);
          const selected = prompt(`🏭 Chọn Factory để thêm mã hàng: (${factoryList.join(", ")})`, factoryList[0]);
          if (!selected || !factoryList.includes(selected)) {
            alert("⚠️ Factory không hợp lệ.");
            return null;
          }
          return selected;
        }


        let newTasks = [];

function acceptToGantt(itemId, season, po) {
  const currentFactory = document.getElementById('factoryFilter')?.value || 'TH1';
  const currentTeam = FactoryData.find(f => f.Factory === currentFactory)?.teams?.[0]?.team || '';

  const info = waitTasks.find(t => t.itemId === itemId && t.season === season && t.po === po) || {};
  const entry = waitsize.find(w => w.itemId === itemId && w.season === season && w.po === po);

  const cm = parseFloat(document.getElementById('inputCm')?.value);
  const t = parseFloat(document.getElementById('inputT')?.value);
  const safeCm = !isNaN(cm) && cm > 0 ? cm : 1;
  const safeT = !isNaN(t) && t > 0 ? t : 0.1;

  const sizeRows = document.querySelectorAll('#newSizeTable tbody tr');
  let sizes = [];

  // ✅ Ưu tiên lấy từ bảng nhập
  if (sizeRows.length > 0) {
    sizes = Array.from(sizeRows).map(row => {
      const sizeName = row.cells[0]?.textContent.trim();
      const input = row.cells[1]?.querySelector('input');
      const quantity = input && input.value !== '' ? parseInt(input.value) : null;
      return { size: sizeName, quantity };
    }).filter(s => s.quantity !== null);
  }

  // 🔁 Nếu bảng rỗng hoặc size = 0 → fallback từ waitsize
  if (sizes.length === 0 || sizes.every(s => s.quantity <= 0)) {
    if (entry && Array.isArray(entry.sizes)) {
      sizes = entry.sizes.map(s => ({
        size: s.size,
        quantity: parseInt(s.quantity) || 0
      }));
    }
  }

  // ✅ Kiểm tra số lượng
  const totalQuantity = sizes.reduce((sum, s) => sum + s.quantity, 0);
  if (sizes.length === 0 || totalQuantity <= 0 || parseInt(info.quantity || 0) === 0) {
    alert("❗ Chưa nhập số lượng sản xuất hợp lệ.");
    console.warn("❗ Tổng quantity không hợp lệ:", {
      sizes,
      waitTaskQuantity: info.quantity
    });
    return;
  }

  // 🔁 Sinh PO mới nếu trùng
  let finalPO = po;
  let suffix = 1;
  while (tasks.some(t =>
    t.itemId === itemId && t.season === season && t.po === finalPO
  )) {
    finalPO = `${po}(${suffix++})`;
  }

  const formattedNplDate = formatDate(info.NplDate || '');
  const formattedGhDate = formatDate(info.GhDate || '');

  // 👉 Đoán nhóm size từ sizes
  let groupName = entry?.groupsize || '';
  if (sizes.length > 0) {
    const currentSizes = sizes.map(s => s.size);
    const matchedGroup = Groupsize.find(g => {
      if (!Array.isArray(g.sizes)) return false;
      const groupSizes = g.sizes.map(s => typeof s === 'string' ? s : s.size);
      return groupSizes.length === currentSizes.length &&
             groupSizes.every(s => currentSizes.includes(s));
    });
    groupName = matchedGroup?.groupsize || matchedGroup?.Groupsizename || groupName;
  }

  // ✅ Ghi Producttail
  Producttail.push({
    itemId, season, po: finalPO,
    customer: info.customer || '',
    code: info.code || '',
    cm: safeCm,
    t: safeT,
    quantity: totalQuantity,
    NplDate: formattedNplDate,
    GhDate: formattedGhDate
  });

  // ✅ Ghi size
  size.push({ itemId, season, po: finalPO, sizes });

  // ✅ Ghi Product
  const startDate = getDefaultStartDate();
  const endDate = estimateEndDateByNs({ quantity: totalQuantity, cm: safeCm, t: safeT, productivity: 35, startDate });
  Product.push({
    itemId, season, po: finalPO,
    customer: info.customer || '',
    code: info.code || '',
    startDate,
    endDate
  });

  // ✅ Ghi task
  const newTask = {
    Factory: currentFactory,
    team: currentTeam,
    itemId, season, po: finalPO,
    customer: info.customer || '',
    code: info.code || '',
    startDate,
    endDate,
    quantity: totalQuantity,
    cm: safeCm,
    t: safeT,
    productivity: 35
  };
  tasks.push(newTask);

  // ✅ Ghi groupSize nếu chưa có
  if (!Groupsize.some(g => g.groupsize === groupName || g.Groupsizename === groupName)) {
    Groupsize.push({
      groupsize: groupName,
      sizes: sizes.map(s => ({ size: s.size }))
    });
  }

  // ✅ Cập nhật lại group cho waitsize
  if (entry) {
    entry.groupsize = groupName;
  }

  // ❌ Xoá khỏi waitTasks
  const waitIndex = waitTasks.findIndex(t =>
    t.itemId === itemId && t.season === season && t.po === po
  );
  if (waitIndex !== -1) waitTasks.splice(waitIndex, 1);

  // ✅ Vẽ Gantt
  const bar = createTaskBar(newTask);
  const row = document.querySelector(`#timelineBody .task-row[data-team="${currentTeam}"]`);
  if (row && bar) row.appendChild(bar);


  // ✅ Gán kéo
setTimeout(() => {
  if (!bar) return;
  const rect = bar.getBoundingClientRect();
  const event = new MouseEvent('mousedown', {
    bubbles: true,
    cancelable: true,
    clientX: rect.left + 10,
    clientY: rect.top + 10
  });
  bar.dispatchEvent(event);
}, 50);


  // ✅ Đóng modal
  document.getElementById('newTasksModal').style.display = 'none';
  alert(`✅ Đã thêm mã hàng vào Gantt (${finalPO})`);
}




        function formatDate(str) {
          const d = new Date(str);
          if (isNaN(d)) return '';
          return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        }





        function getDefaultStartDate() {
          const today = new Date();
          const prevDate = new Date(today); // clone để không làm thay đổi `today`
          prevDate.setDate(prevDate.getDate() - 19);

          const result = formatDate(prevDate); // chuẩn "dd/mm/yyyy"

          console.log("📆 getDefaultStartDate() ➜", result);
          return result;
        }




        function saveTasksFromGanttLikeImport() {
          // ✅ 1. Normalize + Merge đầy đủ dữ liệu
          const normalized = normalizeTasks(tasks);
          const merged = mergeTaskWithProductAndTail(normalized, Product, Producttail);

          // ✅ 2. Chuẩn bị dữ liệu như export
          const dataRows = [];
          const sizeSheet = [];

          merged.forEach(task => {
            const row = {
              Factory: task.Factory,
              Team: task.team,
              ItemID: task.itemId,
              Season: task.season,
              PO: task.po,
              Customer: task.customer,
              Code: task.code,
              Quantity: task.quantity,
              CM: task.cm,
              T: task.t,
              StartDate: task.startDate,
              EndDate: task.endDate,
              NPLDate: task.NplDate,
              GiaoHang: task.GhDate
            };
            dataRows.push(row);

            // Lấy size nếu có
            const sizeEntry = size.find(s => s.itemId === task.itemId && s.season === task.season && s.po === task.po);
            if (sizeEntry) {
              sizeEntry.sizes.forEach(s => {
                sizeSheet.push({
                  ItemID: task.itemId,
                  Season: task.season,
                  PO: task.po,
                  Size: s.size,
                  Quantity: s.quantity
                });
              });
            }
          });

          // ✅ 3. Xóa sạch dữ liệu cũ
          tasks.length = 0;
          Product.length = 0;
          Producttail.length = 0;
          size.length = 0;
          if (typeof outputs === 'object') {
            Object.keys(outputs).forEach(k => delete outputs[k]);
          }

          // ✅ 4. Nhập lại dữ liệu như file Excel
          dataRows.forEach(row => {
            tasks.push({
              Factory: row.Factory,
              team: row.Team,
              itemId: row.ItemID,
              season: row.Season,
              po: row.PO,
              status: "pending"
            });

            Product.push({
              itemId: row.ItemID,
              season: row.Season,
              po: row.PO,
              customer: row.Customer,
              code: row.Code,
              startDate: row.StartDate,
              endDate: row.EndDate
            });

            Producttail.push({
              itemId: row.ItemID,
              season: row.Season,
              po: row.PO,
              quantity: parseInt(row.Quantity),
              cm: parseFloat(row.CM),
              t: parseFloat(row.T),
              NplDate: row.NPLDate,
              GhDate: row.GiaoHang
            });
          });

          const sizeMap = new Map();
          sizeSheet.forEach(row => {
            const key = `${row.ItemID}-${row.Season}-${row.PO}`;
            if (!sizeMap.has(key)) {
              sizeMap.set(key, {
                itemId: row.ItemID,
                season: row.Season,
                po: row.PO,
                sizes: []
              });
            }
            sizeMap.get(key).sizes.push({
              size: row.Size,
              quantity: parseInt(row.Quantity)
            });
          });
          size.push(...Array.from(sizeMap.values()));

          alert("✅ Đã lưu lại đầy đủ dữ liệu Gantt vào bộ nhớ (như import lại từ Excel).");
        }




        function handleRemoveFromGantt() {
          const menu = document.getElementById('updateMenu');
          const itemId = menu?.dataset?.itemId;
          const season = menu?.dataset?.season;
          const po = menu?.dataset?.po;

          console.log("🧪 Check ID/Season/PO:", { itemId, season, po });

          if (!itemId || !season || !po) {
            alert("⚠️ Không tìm thấy mã hàng cần xoá.");
            return;
          }

          const confirmDel = confirm(`❓ Bạn chắc chắn muốn đưa mã hàng ${itemId} - ${po} về danh sách chờ?`);
          if (!confirmDel) return;

          removeTaskFromGantt(itemId, season, po, 'manual');

        }


function removeTaskFromGantt(itemId, season, po, source = 'manual') {
  const key = `${itemId}-${season}-${po}`;

  const task = tasks.find(t => `${t.itemId}-${t.season}-${t.po}` === key);
  const detail = Producttail.find(t => `${t.itemId}-${t.season}-${t.po}` === key);
  const product = Product.find(p => `${p.itemId}-${p.season}-${p.po}` === key);
  const sizeEntry = size.find(s => `${s.itemId}-${s.season}-${s.po}` === key);

  // Đoán nhóm size
  let groupName = waitsize.groupsize;
  if (sizeEntry && Array.isArray(sizeEntry.sizes)) {
    const currentSizes = sizeEntry.sizes.map(s => s.size);
    const matchedGroup = Groupsize.find(g => {
      if (!Array.isArray(g.sizes)) return false;
      const groupSizes = g.sizes.map(s => typeof s === 'string' ? s : s.size);
      return groupSizes.length === currentSizes.length &&
             groupSizes.every(s => currentSizes.includes(s));
    });
    groupName = matchedGroup?.groupsize ;
  }
  console.log("🟡 [TRƯỚC REMOVE] size:", JSON.parse(JSON.stringify(size)));
    console.log("🟡 [TRƯỚC REMOVE] waitsize:", JSON.parse(JSON.stringify(waitsize)));
  // Dữ liệu chung
  const customer = task?.customer || product?.customer || '';
  const code = task?.code || product?.code || '';
  const rawNpl = detail?.NplDate || product?.NplDate || '';
  const rawGh = detail?.GhDate || product?.GhDate || '';
  const NplDate = rawNpl;
  const GhDate = rawGh;
  const cm = parseFloat(detail?.cm) || 0;
  const t = parseFloat(detail?.t) || 0;
  const cmt = cm + t;
  const quantity = Math.max(1, parseInt(detail?.quantity) || 0);

  if (source === 'manual') {
    // ✅ Thêm lại vào wait nếu gọi từ handleRemoveFromGantt
    if (!waitTasks.some(t => `${t.itemId}-${t.season}-${t.po}` === key)) {
      waitTasks.push({
        itemId, season, po, customer, code,
        NplDate, GhDate, cm, t, cmt, quantity,
        groupsize: groupName
      });
    }

    if (sizeEntry && !waitsize.some(w => `${w.itemId}-${w.season}-${w.po}` === key)) {
      waitsize.push({
        itemId, season, po,
        customer, code,
        groupsize: groupName,
        sizes: sizeEntry.sizes,
        quantity
      });
    }

    if (sizeEntry && !Groupsize.some(g => g.groupsize === groupName)) {
      Groupsize.push({
        groupsize: groupName,
        sizes: sizeEntry.sizes
      });
    }
  } else if (source === 'auto') {
    // ✅ Xoá dữ liệu khỏi wait nếu gọi từ saveOutput (mã đã hoàn thành)
    waitTasks = waitTasks.filter(w => `${w.itemId}-${w.season}-${w.po}` !== key);
    waitsize = waitsize.filter(w => `${w.itemId}-${w.season}-${w.po}` !== key);
    // Không mở modal
  }

  // ❌ Xoá khỏi dữ liệu chính
  tasks = tasks.filter(t => `${t.itemId}-${t.season}-${t.po}` !== key);
  Product = Product.filter(p => `${p.itemId}-${p.season}-${p.po}` !== key);
  Producttail = Producttail.filter(p => `${p.itemId}-${p.season}-${p.po}` !== key);
  size = size.filter(s => `${s.itemId}-${s.season}-${s.po}` !== key);

  const bar = document.querySelector(`.task-bar[data-taskid="${itemId}-${po}"]`);
  if (bar) bar.remove();

  renderTasksByFactory(document.getElementById('factoryFilter')?.value || 'TH1');
  loadAvailableTasks();

  // Xoá rác
  waitTasks = waitTasks.filter(w => w.itemId);
  waitsize = waitsize.filter(w => w.itemId);
  waitgroupSizes = waitgroupSizes.filter(g => g.groupsize);
console.log("🟢 [SAU REMOVE] size:", JSON.parse(JSON.stringify(size)));
console.log("🟢 [SAU REMOVE] waitsize:", JSON.parse(JSON.stringify(waitsize)));
    
  if (source === 'manual') {
    openNewProductModalWithData({
      itemId, season, po, customer, code,
      NplDate, GhDate, cm, t, cmt,
      groupsize: groupName
    });

    alert(`✅ Đã đưa mã hàng ${itemId} - ${po} về danh sách chờ.`);
  } else {
    console.log(`✅ Đã xoá mã hàng ${itemId} - ${po} vì đã hoàn thành.`);
  }
}




        function getGroupNameFromSize(sizeEntry) {
          const currentSizes = sizeEntry.sizes.map(s => s.size);
          const matchedGroup = Groupsize.find(g => {
            const groupSizes = g.size;
            return groupSizes.length === currentSizes.length &&
                   groupSizes.every(size => currentSizes.includes(size));
          });
          return matchedGroup?.Groupsizename ;
        }


        function openSplitSizeModal(itemId, season, po) {
          const key = `${itemId}-${season}-${po}`;
          const sizeEntry = size.find(s => `${s.itemId}-${s.season}-${s.po}` === key);

          if (!sizeEntry) {
            alert("❌ Không có dữ liệu size.");
            return;
          }

          const form = document.getElementById('splitSizeForm');
          form.dataset.itemId = itemId;
          form.dataset.season = season;
          form.dataset.po = po;

          const list = document.getElementById('splitSizeList');
          list.innerHTML = sizeEntry.sizes.map(s => `
            <div style="margin-bottom: 6px;">
              <label>Size ${s.size} (tổng: ${s.quantity})</label>
              <input type="number" name="${s.size}" min="0" max="${s.quantity}" value="${s.quantity}" />
            </div>
          `).join('');

          document.getElementById('splitSizeModal').style.display = 'block';
        }
        document.getElementById('splitSizeForm').addEventListener('submit', function (e) {
          e.preventDefault();
          const form = e.target;

          const itemId = form.dataset.itemId;
          const season = form.dataset.season;
          const po = form.dataset.po;
          const key = `${itemId}-${season}-${po}`;

          const task = tasks.find(t => `${t.itemId}-${t.season}-${t.po}` === key);
          const detail = Producttail.find(t => `${t.itemId}-${t.season}-${t.po}` === key);
          const product = Product.find(p => `${p.itemId}-${p.season}-${p.po}` === key);
          const sizeEntry = size.find(s => `${s.itemId}-${s.season}-${s.po}` === key);

          if (!task || !detail || !product || !sizeEntry) {
            alert("❌ Không tìm thấy dữ liệu.");
            return;
          }

          const formData = new FormData(form);
          const splitSizes = [];
          let totalSplit = 0;
          let totalRemain = 0;

          sizeEntry.sizes.forEach(s => {
            const input = parseInt(formData.get(s.size)) || 0;
            const splitQty = Math.min(input, s.quantity);
            const remainQty = s.quantity - splitQty;

            splitSizes.push({
              size: s.size,
              quantity: splitQty,
              remain: remainQty
            });

            totalSplit += splitQty;
            totalRemain += remainQty;
          });

          if (totalSplit === 0 || totalRemain === 0) {
            alert("❌ Cần phân bổ ít nhất một phần sản xuất và một phần chờ.");
            return;
          }

          // ✅ Cập nhật phần sản xuất
          detail.quantity = totalSplit;
          product.quantity = totalSplit;
          task.quantity = totalSplit;
          sizeEntry.sizes = splitSizes.map(s => ({ size: s.size, quantity: s.quantity }));

          let counter = 2;
            let newPo = `${po}(${counter})`;
            while (
              tasks.some(t => t.itemId === itemId && t.season === season && t.po === newPo) ||
              Product.some(p => p.itemId === itemId && p.season === season && p.po === newPo) ||
              waitTasks.some(w => w.itemId === itemId && w.season === season && w.po === newPo)
            ) {
              counter++;
              newPo = `${po}-${counter}`;
            }


          const groupName = getGroupNameFromSize(sizeEntry);

          // ✅ Ghi phần chờ
          waitTasks.push({
            itemId, season, po: newPo, customer: product.customer, code: product.code,
            NplDate: formatDate(detail.NplDate), GhDate: formatDate(detail.GhDate),
            cm: detail.cm, t: detail.t, cmt: detail.cm + detail.t,
            quantity: totalRemain,
            groupsize: groupName,
            startDate: getDefaultStartDate()
          });

          waitsize.push({
            itemId, season, po: newPo,
            customer: product.customer, code: product.code,
            groupsize: groupName,
            quantity: totalRemain
          });

          waitgroupSizes.push({
            groupsize: groupName,
            sizes: splitSizes.map(s => ({ size: s.size, quantity: s.remain }))
          });

          console.log("✂️ Tách theo size hoàn tất:", splitSizes);
          alert(`✅ Đã tách: ${totalSplit} để sản xuất, ${totalRemain} chờ.`);

          renderTasksByFactory(document.getElementById('factoryFilter').value);
          loadAvailableTasks();
           // ✅ Cleanup bản ghi rỗng
          waitTasks = waitTasks.filter(w => w.itemId);
          waitsize = waitsize.filter(w => w.itemId);
          waitgroupSizes = waitgroupSizes.filter(g => g.groupsize);

        openNewProductModalWithData({
          itemId,
          season,
          po: newPo,
          customer: product.customer,
          code: product.code,
          NplDate: formatDate(detail.NplDate),
          GhDate: formatDate(detail.GhDate),
          cm: detail.cm,
          t: detail.t,
          cmt: detail.cm + detail.t,
          quantity: totalRemain,
          groupsize: groupName
        });


          closeSplitSizeModal();
        });
        function closeSplitSizeModal() {
          document.getElementById('splitSizeModal').style.display = 'none';
        }






        function preventSpace(e) {
          if (e.key === ' ') {
            e.preventDefault(); // chặn phím space
          }
        }
        function allowOnlyLettersAndNumbers(id) {
          const input = document.getElementById(id);
          if (!input) return; // Không tìm thấy input => thoát hàm

          input.addEventListener('input', () => {
            input.value = input.value.replace(/[^a-zA-Z0-9]/g, '');
          });
        }

        ['newItemId', 'newSeason', 'newPo', 'newCustomer', 'newCode', 'inputSize'].forEach(allowOnlyLettersAndNumbers);




        function preventPasteWhitespace(id) {
          const input = document.getElementById(id);
          if (!input) {
            console.warn(`⚠️ Không tìm thấy element với ID: ${id}`);
            return;
          }

          input.addEventListener('paste', (e) => {
            e.preventDefault(); // chặn hành vi dán mặc định
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const clean = paste.replace(/\s+/g, ''); // xóa toàn bộ khoảng trắng
            // Chèn lại chuỗi đã làm sạch
            if (document.execCommand) {
              document.execCommand('insertText', false, clean);
            } else if (input.setRangeText) {
              const start = input.selectionStart;
              const end = input.selectionEnd;
              input.setRangeText(clean, start, end, 'end');
            } else {
              input.value += clean;
            }
          });
        }

        ['newItemId', 'newSeason', 'newPo', 'newCustomer', 'newCode', 'inputSize'].forEach(preventPasteWhitespace);


        function fillProductivityTable(itemId, season, po) {
          const tbody = document.getElementById('productivityTableBody');
          tbody.innerHTML = '';

          // ✅ Tìm task tương ứng trong tasks hoặc waitTasks
          const task =
            tasks.find(t => t.itemId === itemId && t.season === season && t.po === po) ||
            waitTasks.find(t => t.itemId === itemId && t.season === season && t.po === po);

          const quantity = task?.quantity || 0;

          // ✅ Lọc các bản ghi productivity theo mã hàng
          const filtered = productivity.filter(p =>
            p.itemId === itemId && p.season === season && p.po === po
          );

          if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Không có dữ liệu năng suất</td></tr>`;
            return;
          }

          // ✅ Đổ bảng
          filtered.forEach(p => {
            const avg = p.averageprice || 0;
            const estHours = avg > 0 ? (quantity / avg).toFixed(2) : '-';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${p.team}</td>
              <td>${p.Factory}</td>
              <td>${avg} sp/h</td>
              <td>${quantity}</td>
              <td>${estHours}</td>
            `;
            tbody.appendChild(tr);
          });
        }


        // Menu Setting (context popup)
        document.getElementById("btnSetting").addEventListener("click", function (e) {
          const menu = document.getElementById("modalSetting");
          menu.style.display = menu.style.display === "none" ? "block" : "none";
          menu.style.left = `${e.pageX}px`;
          menu.style.top = `${e.pageY}px`;
        });

        document.addEventListener("click", function (e) {
          const setting = document.getElementById("modalSetting");
          const button = document.getElementById("btnSetting");
          if (!setting.contains(e.target) && !button.contains(e.target)) {
            setting.style.display = "none";
          }
        });



        function openSizeList() {
            document.getElementById("modalSizeList").style.display = "flex";
            renderGroupSizeList();
          }

          function closeSizeList() {
            document.getElementById("modalSizeList").style.display = "none";
          }

function renderGroupSizeList() {
  const ul = document.getElementById("groupSizeList");
  ul.innerHTML = "";

  Groupsize.forEach((group, index) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";

    // 🔒 Chuẩn hóa size list an toàn
    const sizeList = Array.isArray(group.sizes)
      ? group.sizes
          .filter(s => s && s.size) // bỏ undefined/null/không có size
          .map(s => s.size)
          .join(', ')
      : '<span class="text-danger">❌ Không có size</span>';

    li.innerHTML = `
      <span><strong>${group.groupsize}</strong>: ${sizeList}</span>
      <button class="btn btn-sm btn-danger" onclick="removeGroupSize(${index})">🗑</button>
    `;

    ul.appendChild(li);
  });
}



        function addGroupSize() {
  const name = document.getElementById("groupName").value.trim();
  const rawSizes = document.getElementById("groupSizes").value.trim();

  const sizes = rawSizes
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .map(size => ({ size })); // ✅ chuyển thành object {size: 'S'}

  if (!name || sizes.length === 0) {
    alert("Vui lòng nhập đầy đủ tên nhóm và danh sách size.");
    return;
  }

  // Tránh trùng tên nhóm
  const exists = Groupsize.some(g => g.groupsize === name);
  if (exists) {
    alert("❗ Nhóm size đã tồn tại.");
    return;
  }

  // ✅ Thêm vào Groupsize với đúng cấu trúc
  Groupsize.push({ groupsize: name, sizes });

  // Reset input
  document.getElementById("groupName").value = "";
  document.getElementById("groupSizes").value = "";

  renderGroupSizeList();      // cập nhật danh sách hiển thị
  renderSizeGroupOptions();   // cập nhật dropdown + render lại bảng size
}


          function removeGroupSize(index) {
            if (confirm("Bạn có chắc muốn xoá nhóm size này không?")) {
              Groupsize.splice(index, 1);
              renderGroupSizeList();
            }
          }
          function modalSizeList() {
          document.getElementById("modalSizeList").style.display = "flex";
        }

        function openChuyenSetting() {
          const container = document.getElementById('chuyenSettingsContainer');
          container.innerHTML = '';

          FactoryData.forEach(factory => {
            const div = document.createElement('div');
            div.style.marginBottom = '20px';

            div.innerHTML = `
              <h5 style="color:#d46b08">${factory.Factory}</h5>
              <table class="table table-bordered table-sm" style="margin-bottom:10px;">
                <thead><tr><th>Chuyền</th><th>Số LĐ</th><th>Xoá</th></tr></thead>
                <tbody id="tbody-${factory.Factory}"></tbody>
              </table>

              <div style="display:flex; gap:10px;">
                <input type="text" id="newTeam-${factory.Factory}" class="form-control" placeholder="Tên chuyền mới">
                <input type="number" id="newSld-${factory.Factory}" class="form-control" placeholder="Số LĐ" min="0" style="max-width:100px;">
                <button class="btn btn-success btn-sm" onclick="addTeam('${factory.Factory}')">➕ Thêm chuyền</button>
              </div>
            `;

            container.appendChild(div);

            renderChuyenTable(factory.Factory);
            renderFactoryList();
          });

          document.getElementById('modalChuyenSetting').style.display = 'flex';
        }
        function renderChuyenTable(factoryName) {
          const tbody = document.getElementById(`tbody-${factoryName}`);
          tbody.innerHTML = '';

          const factory = FactoryData.find(f => f.Factory === factoryName);
          if (!factory) return;

          factory.teams.forEach((team, idx) => {
            const row = document.createElement('tr');
            row.setAttribute('data-index', idx);

            row.innerHTML = `
              <td><input type="text" class="form-control form-control-sm" value="${team.team}" onchange="factoryUpdateTeamName('${factoryName}', ${idx}, this.value)" /></td>
              <td><input type="number" class="form-control form-control-sm" value="${team.sld}" onchange="factoryUpdateSld('${factoryName}', ${idx}, this.value)" /></td>
              <td><button class="btn btn-sm btn-danger" onclick="removeTeam('${factoryName}', ${idx})">🗑</button></td>
            `;

            tbody.appendChild(row);
          });

          // 🔄 Gắn Sortable nếu chưa có
          if (!tbody.classList.contains('sortable-enabled')) {
            new Sortable(tbody, {
              animation: 150,
              handle: 'td', // hoặc dùng drag handle riêng nếu cần
              onEnd: function (evt) {
                const factory = FactoryData.find(f => f.Factory === factoryName);
                if (!factory) return;

                const movedItem = factory.teams.splice(evt.oldIndex, 1)[0];
                factory.teams.splice(evt.newIndex, 0, movedItem);

                renderChuyenTable(factoryName); // re-render để cập nhật lại chỉ số
              }
            });

            tbody.classList.add('sortable-enabled');
          }
        }

        function addTeam(factoryName) {
          const name = document.getElementById(`newTeam-${factoryName}`).value.trim();
          const sld = parseInt(document.getElementById(`newSld-${factoryName}`).value);

          if (!name || isNaN(sld)) {
            alert("❗ Vui lòng nhập tên chuyền và số LĐ.");
            return;
          }

          const factory = FactoryData.find(f => f.Factory === factoryName);
          if (!factory) return;

          // 🔒 Kiểm tra trùng tên chuyền
          if (factory.teams.some(t => t.team === name)) {
            alert("❗ Chuyền đã tồn tại.");
            return;
          }

          factory.teams.push({ team: name, sld });
          renderChuyenTable(factoryName);

          // reset input
          document.getElementById(`newTeam-${factoryName}`).value = '';
          document.getElementById(`newSld-${factoryName}`).value = '';
        }


        function factoryUpdateTeamName(factoryName, index, newName) {
          const factory = FactoryData.find(f => f.Factory === factoryName);
          if (factory && factory.teams[index]) {
            factory.teams[index].team = newName;
          }
        }

        function factoryUpdateSld(factoryName, index, newSld) {
          const factory = FactoryData.find(f => f.Factory === factoryName);
          if (factory && factory.teams[index]) {
            factory.teams[index].sld = parseInt(newSld);
          }
        }

        function removeTeam(factoryName, index) {
          const factory = FactoryData.find(f => f.Factory === factoryName);
          if (factory && confirm("Bạn có chắc muốn xoá chuyền này?")) {
            factory.teams.splice(index, 1);
            renderChuyenTable(factoryName);
          }
        }

        function closeChuyenSetting() {
          document.getElementById('modalChuyenSetting').style.display = 'none';
          const currentFactory = document.getElementById('factoryFilter')?.value || 'TH1';
          renderTasksByFactory(currentFactory);
        }

        function addFactory() {
          const name = document.getElementById('newFactoryName').value.trim();
          if (!name) {
            alert("❗ Vui lòng nhập tên nhà máy.");
            return;
          }

          // 🔒 Check trùng tên
          if (FactoryData.some(f => f.Factory === name)) {
            alert("❗ Nhà máy đã tồn tại.");
            return;
          }

          FactoryData.push({ Factory: name, teams: [] });
          document.getElementById('newFactoryName').value = '';
          openChuyenSetting(); // re-render
        }

        function renderFactoryList() {
          const ul = document.getElementById('factoryList');
          ul.innerHTML = '';

          FactoryData.forEach((factory, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';

            li.innerHTML = `
              <input type="text" value="${factory.Factory}" class="form-control form-control-sm" 
                onchange="renameFactory(${index}, this.value)" style="max-width: 300px;">
              <button class="btn btn-danger btn-sm" onclick="removeFactory(${index})">🗑</button>
            `;
            ul.appendChild(li);
          });
        }

                function renameFactory(index, newName) {
          newName = newName.trim();
          if (!newName) return;

          if (FactoryData.some((f, i) => i !== index && f.Factory === newName)) {
            alert("❗ Tên nhà máy đã tồn tại.");
            renderFactoryList(); // reset input lại
            return;
          }

          FactoryData[index].Factory = newName;
          openChuyenSetting(); // để cập nhật lại toàn bộ bảng
        }

        function removeFactory(index) {
          if (!confirm("Bạn có chắc muốn xoá nhà máy này?")) return;
          FactoryData.splice(index, 1);
          openChuyenSetting();
        }
        function exportReportToExcel() {
          const table = document.querySelector('#reportResult table');
          if (!table) {
            alert("❗ Không có dữ liệu để xuất.");
            return;
          }

          // 📤 Chuyển bảng HTML thành worksheet
          const ws = XLSX.utils.table_to_sheet(table);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "BaoCaoTienDo");

          const now = new Date();
          const dateStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
          const factory = currentFactoryInReport || "Factory";
          const fileName = `BaoCaoTienDo_${factory}_${dateStr}.xlsx`;

          XLSX.writeFile(wb, fileName);
        }
    
function evaluateExpression(input) {
  const text = input.value.replace(/[^0-9+\-*/().]/g, ''); // Loại ký tự không hợp lệ
  try {
    const result = eval(text);
    if (!isNaN(result)) {
      input.dataset.value = result;
      input.title = `= ${result}`;  // Tooltip hiển thị kết quả
    } else {
      input.dataset.value = '';
      input.title = 'Công thức không hợp lệ';
    }
  } catch {
    input.dataset.value = '';
    input.title = 'Công thức không hợp lệ';
  }
}

function parseDateDDMMYYYY(dateStr) {
  if (!dateStr) return null;
  const [day, month, year] = dateStr.split('/');
  return new Date(`${year}-${month}-${day}T00:00:00`);
}

function checkDeliveryStatus() {
  const selectedCustomer = document.getElementById('customerFilterSelect')?.value || '';
  const selectedFactory = document.getElementById('factoryFilter')?.value || '';
  const normalized = normalizeTasks(tasks);
  const merged = mergeTaskWithProductAndTail(normalized, Product, Producttail);

  const rows = [];

  merged.forEach(task => {
    if (selectedCustomer && task.customer !== selectedCustomer) return;
    if (selectedFactory && task.Factory !== selectedFactory) return;

    const taskKey = `${task.itemId}-${task.season}`;
    const outputList = outputs[taskKey]?.[task.po] || [];

    // ✅ TÍNH TỔNG LƯỢNG ĐÓNG THÙNG VÀ LỌC MÃ HÀNG ĐÃ HOÀN THÀNH
    const totalBox = outputList.reduce((sum, e) => sum + (e.box || 0), 0);
    if (totalBox >= task.quantity) {
      return; // Bỏ qua mã hàng này nếu đã hoàn thành
    }

    const totalOutput = outputList.reduce((sum, e) => sum + (e.value || 0), 0);
    const remaining = task.quantity - totalOutput;

    // ================= LOGIC TÍNH NS CẦN ĐẠT =================
    let requiredNS = 'N/A';
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Chuẩn hóa ngày hôm nay

    if (totalOutput > 0) {
      // ĐIỀU KIỆN 1: Đã có sản lượng
      const endDateObj = parseDate(task.endDate);
      if (endDateObj && today <= endDateObj) {
        const totalDays = daysBetween(today, endDateObj) + 1; // +1 để tính cả ngày kết thúc
        const sundays = countSundaysBetween(today, endDateObj);
        const workingDays = totalDays - sundays;

        if (workingDays > 0) {
          requiredNS = Math.ceil(remaining / workingDays / 5) * 5;
        } else {
          requiredNS = (remaining > 0) ? '∞' : 0;
        }
      } else {
         requiredNS = (remaining > 0) ? '∞' : 0; // Đã qua ngày kết thúc
      }
    } else {
      // ĐIỀU KIỆN 2: Chưa có sản lượng
      const startDateObj = parseDate(task.startDate);
      const endDateObj = parseDate(task.endDate);

      if (startDateObj && endDateObj && startDateObj <= endDateObj) {
        const totalDays = daysBetween(startDateObj, endDateObj) + 1; // +1 để tính cả ngày kết thúc
        const sundays = countSundaysBetween(startDateObj, endDateObj);
        const workingDays = totalDays - sundays;

        if (workingDays > 0) {
          requiredNS = Math.ceil(task.quantity / workingDays / 5) * 5;
        } else {
          requiredNS = '∞';
        }
      }
    }
    // ================= KẾT THÚC LOGIC =================

    rows.push({
      team: task.team || '-',
      itemId: task.itemId,
      season: task.season,
      po: task.po,
      quantity: task.quantity,
      output: totalOutput,
      remaining,
      endDate: task.endDate,
      ghDate: task.GhDate,
      requiredNS
    });
  });

  // Sắp xếp theo tên chuyền (có xử lý số tự nhiên)
  rows.sort((a, b) => a.team.localeCompare(b.team, undefined, { numeric: true }));

  let html = `
    <table class="report-table">
      <thead>
        <tr>
          <th>Chuyền</th><th>ItemID</th><th>Season</th><th>PO</th>
          <th>Số lượng</th><th>Output</th><th>Còn lại</th>
          <th>NS Cần đạt</th>
          <th>Ngày kết thúc</th><th>Ngày giao hàng</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach(r => {
    const ghDateObj = parseDate(r.ghDate);
    const endDateObj = parseDate(r.endDate);
    const diff = ghDateObj && endDateObj ? endDateObj - ghDateObj : 0;
    const diffDays = diff / (1000 * 60 * 60 * 24);
    const isLate = diffDays >= 0 || diffDays === -1;

    html += `
      <tr ${isLate ? 'style="background-color: #f8d7da;" title="Ngày kết thúc trễ hoặc chỉ sớm hơn 1 ngày so với ngày giao hàng"' : ''}>
        <td>${r.team}</td>
        <td>${r.itemId}</td>
        <td>${r.season}</td>
        <td>${r.po}</td>
        <td>${r.quantity}</td>
        <td>${r.output}</td>
        <td>${r.remaining}</td>
        <td>${r.requiredNS}</td>
        <td>${r.endDate}</td>
        <td>${r.ghDate}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("deliveryCheckResult").innerHTML = html;
  document.getElementById("deliveryCheckModal").style.display = "block";
}
function showItemSuggestions() {
  const keyword = document.getElementById('itemSearchInput')?.value?.trim().toLowerCase();
  const list = document.getElementById('itemSuggestions');
  list.innerHTML = '';
  list.style.display = 'none';

  if (!keyword) return;

  const matched = tasks
    .filter(t => t.itemId.toLowerCase().includes(keyword))
    .map(t => `${t.itemId}::${t.season}::${t.po}`);

  const unique = [...new Set(matched)].slice(0, 10); // giới hạn 10 gợi ý

  if (unique.length) {
    unique.forEach(line => {
      const li = document.createElement('li');
      li.textContent = line;
      li.onclick = () => selectItemSuggestion(line);
      list.appendChild(li);
    });
    list.style.display = 'block';
  }
}

function selectItemSuggestion(line) {
  const [itemId, season, po] = line.split('::');
  document.getElementById('itemSearchInput').value = itemId;
  document.getElementById('itemSuggestions').style.display = 'none';

  const filtered = tasks.filter(t =>
    t.itemId === itemId &&
    t.season === season &&
    t.po === po
  );

  const factory = document.getElementById('factoryFilter')?.value;
  const filteredWithInfo = mergeTaskWithProductAndTail(filtered, Product, Producttail, size);
  renderFilteredTasks(factory, filteredWithInfo);
}

function selectItemSuggestion(line) {
  const [itemId, season, po] = line.split('::');
  document.getElementById('itemSearchInput').value = itemId;
  document.getElementById('itemSuggestions').style.display = 'none';
  showItemDetailModal(itemId, season, po);
}

function showItemDetailModal(itemId, season, po) {
  const filtered = tasks.filter(t =>
    t.itemId === itemId &&
    t.season === season &&
    (Array.isArray(t.po) ? t.po.includes(po) : t.po === po)
  );

  const taskKey = `${itemId}-${season}`;
  const outputList = outputs[taskKey]?.[po] || [];

  const totalOutput = outputList.reduce((sum, e) => sum + (e.value || 0), 0);
  const quantity = Producttail.find(p =>
    p.itemId === itemId && p.season === season && p.po === po
  )?.quantity || 0;

  const remaining = quantity - totalOutput;

  let html = `
    <p><strong>Mã hàng:</strong> ${itemId}</p>
    <p><strong>Season:</strong> ${season}</p>
    <p><strong>PO:</strong> ${po}</p>
    <p><strong>Tổng Số lượng:</strong> ${quantity}</p>
    <p><strong>Tổng Output:</strong> ${totalOutput}</p>
    <p><strong>Còn lại:</strong> ${remaining}</p>
    <hr>
    <table class="report-table">
      <thead>
        <tr>
          <th>Chuyền</th>
          <th>Xưởng</th>
          <th>Sản lượng</th>
        </tr>
      </thead>
      <tbody>
  `;

  const teamMap = {};

  filtered.forEach(task => {
    const team = task.team || 'UNKNOWN';
    const factory = task.Factory || 'UNKNOWN';
    const key = `${factory}::${team}`;
    if (!teamMap[key]) {
      teamMap[key] = { team, factory, total: 0 };
    }

    const outputByTask = outputs[taskKey]?.[po] || [];
    teamMap[key].total += outputByTask.reduce((sum, e) => sum + (e.value || 0), 0);
  });

  Object.values(teamMap).forEach(t => {
    html += `
      <tr ondblclick="openOutputModalFromSearch('${itemId}', '${season}', '${po}')"
          style="cursor:pointer;" title="Double-click để nhập sản lượng">
        <td>${t.team}</td>
        <td>${t.factory}</td>
        <td>${t.total}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;

  document.getElementById('itemDetailContent').innerHTML = html;
  document.getElementById('itemDetailModal').style.display = 'block';
}



function openOutputModalFromSearch(itemId, season, po) {
  // 1. Đóng modal chi tiết mã hàng nếu đang mở
  document.getElementById('itemDetailModal').style.display = 'none';

  // 2. Gán dataset vào menu để openOutputModal sử dụng
  const menu = document.getElementById('updateMenu');
  menu.dataset.itemId = itemId;
  menu.dataset.season = season;
  menu.dataset.po = po;

  // 3. Mở modal nhập sản lượng
  openOutputModal();
}


</script>


            <style>
   
.suggestions-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.suggestions-list li {
  padding: 6px;
  cursor: pointer;
}

.suggestions-list li:hover {
  background-color: #f0f0f0;
}


                .report-table {
  width: 100%;
  border-collapse: collapse;
}
.report-table th, .report-table td {
  border: 1px solid #ccc;
  padding: 4px;
  text-align: center;
}
.report-table tr[style*="background-color"] {
  font-weight: bold;
  color: #721c24;
}

                .late-task {
  box-shadow: 0 0 6px 2px red !important;
  border: 2px solid red;
}

.npl-late {
  border: 2px solid #2196f3;
  box-shadow: 0 0 5px 2px #2196f3 !important;
}

                .modal-setting.hidden {
            display: none;
          }
        #modalSizeList {
          position: fixed;
          inset: 0;
          display: none;
          justify-content: center;
          align-items: center;
          background: rgba(0, 0, 0, 0.4);
          z-index: 10000;
          font-family: 'Arial', sans-serif;
        }

        #modalSizeList .modal-content {
          background-color: #fff9ed;
          border: 1px solid #ffd8a8;
          border-radius: 12px;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
          width: auto;
          max-height: max-content;
          padding: 20px;
          position: relative;
          overflow: hidden;
        }

        #modalSizeList h3 {
          font-size: 20px;
          color: #d46b08;
          border-bottom: 1px solid #ffd8a8;
          padding-bottom: 10px;
          margin-bottom: 16px;
        }

        #modalSizeList label {
          font-weight: bold;
          margin-bottom: 4px;
          display: inline-block;
          color: #874d00;
        }

        #modalSizeList input {
          width: 100%;
          padding: 6px 10px;
          margin-bottom: 10px;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-size: 14px;
        }

        #modalSizeList .btn {
          padding: 8px 14px;
          background: #d46b08;
          color: white;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          margin-top: 10px;
          transition: background 0.2s;
        }

        #modalSizeList .btn:hover {
          background: #a35a00;
        }

        #modalSizeList .list-group-item {
          padding: 8px 12px;
          border: 1px solid #ffd8a8;
          background-color: #fffbe6;
          margin-top: 6px;
          border-radius: 4px;
          font-size: 14px;
        }
        #modalSizeList .close {
          position: absolute;
          top: 14px;
          right: 20px;
          font-size: 22px;
          cursor: pointer;
          color: #874d00;
          font-weight: bold;
        }

        #modalSizeList .close:hover {
          color: #d32f2f;
        }

        #modalChuyenSetting {
          position: fixed;
          inset: 0;
          display: none;
          justify-content: center;
          align-items: center;
          background: rgba(0, 0, 0, 0.4);
          z-index: 10000;
          font-family: 'Arial', sans-serif;
        }

        #modalChuyenSetting .modal-content {
          background-color: #fff9ed;
          border: 1px solid #ffd8a8;
          border-radius: 12px;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
          width: 90%;
          max-width: 700px;
          max-height: 80vh;
          overflow-y: auto;
          padding: 20px;
          position: relative;
        }

        #modalChuyenSetting h3 {
          font-size: 20px;
          color: #d46b08;
          border-bottom: 1px solid #ffd8a8;
          padding-bottom: 10px;
          margin-bottom: 16px;
        }

        #modalChuyenSetting table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 10px;
          font-size: 14px;
        }

        #modalChuyenSetting th,
        #modalChuyenSetting td {
          border: 1px solid #ccc;
          padding: 8px 10px;
          text-align: left;
        }

        #modalChuyenSetting th {
          background-color: #fff3cd;
          color: #874d00;
          font-weight: 600;
        }

        #modalChuyenSetting .form-control {
          width: 95%;
          padding: 6px 8px;
          font-size: 14px;
          border: 1px solid #ccc;
          border-radius: 6px;
        }

        #modalChuyenSetting .btn {
          padding: 6px 12px;
          font-size: 13px;
          border-radius: 6px;
          border: none;
          cursor: pointer;
          font-weight: bold;
        }

        #modalChuyenSetting .btn-success {
          background-color: #28a745;
          color: #fff;
        }

        #modalChuyenSetting .btn-danger {
          background-color: #dc3545;
          color: #fff;
        }

        #modalChuyenSetting .btn-secondary {
          background-color: #6c757d;
          color: #fff;
        }

        #modalChuyenSetting .btn:hover {
          opacity: 0.9;
        }

        #modalChuyenSetting .close {
          position: absolute;
          top: 14px;
          right: 20px;
          font-size: 22px;
          cursor: pointer;
          color: #874d00;
          font-weight: bold;
        }

        #modalChuyenSetting .close:hover {
          color: #d32f2f;
        }

            </style>
            </html>
